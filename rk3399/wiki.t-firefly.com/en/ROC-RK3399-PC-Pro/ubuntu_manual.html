

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->

<!-- Mirrored from wiki.t-firefly.com/en/ROC-RK3399-PC-Pro/ubuntu_manual.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 29 Sep 2022 08:28:38 GMT -->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Firefly Ubuntu User Manual &mdash; Firefly Wiki</title>
  
  <meta name="keywords" content="ROC-RK3399-PC Pro">
  <meta name="description" content="ROC-RK3399-PC Pro uses RK3399 6-core (A72x2+A53x4) 64-bit processor with a main frequency of up to 1.8GHz. It integrates four-core Mali-T860 GPU with excellent performance.">
  
  
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="_static/css/themec652.css?v=20201016" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          <!-- <img class="logo" src="_images/Logo.png"> -->

            
           
          <a href="http://wiki.t-firefly.com/en/" class="logo_a">
            <img src="_static/Logo.png" class="logo" alt="Logo" />
          </a>
          

          

          
            <a href="index.html" class="icon icon-home"> ROC-RK3399-PC Pro Manual
          

          
          </a>

          
            
            
              <div class="version">
                2.0.6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="https://wiki.t-firefly.com/en/ROC-RK3399-PC-Pro/search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            

            
              <p class="caption"><span class="caption-text">ROC-RK3399-PC Pro</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="preface.html">Preface</a></li>
</ul>
<p class="caption"><span class="caption-text">Quick Start</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="started.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="debug.html">Serial debug</a></li>
</ul>
<p class="caption"><span class="caption-text">Upgrade Firmware</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="01-bootmode.html">1. Introduction to updating firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="FW_Changelog.html">2. Firmware update log</a></li>
<li class="toctree-l1"><a class="reference internal" href="02-upgrade_table.html">3. Instructions for writing with USB cable (important)</a></li>
</ul>
<p class="caption"><span class="caption-text">Linux</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="linux_compile_gpt.html">1. Compile Ubuntu firmware(GPT)</a></li>
<li class="toctree-l1"><a class="reference internal" href="ubuntu_desktop_support.html">2. Firefly Ubuntu Desktop Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="ubuntu_minimal_support.html">3. Firefly Ubuntu Minimal Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="more_Linux_OS_support.html">4. <font color="red">More Linux OS support</font></a></li>
<li class="toctree-l1"><a class="reference internal" href="more_technical_cases_show.html">5. More technical cases show</a></li>
<li class="toctree-l1"><a class="reference internal" href="firefly_linux_guide.html">6. Firefly Linux User Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">Android</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="adb_use.html">1. ADB use</a></li>
<li class="toctree-l1"><a class="reference internal" href="prepare_compile_android.html">2. Compile environment to build</a></li>
<li class="toctree-l1"><a class="reference internal" href="compile_android7.1_industry_firmware.html">3. Compile Android7.1 Industry firmware</a></li>
<li class="toctree-l1"><a class="reference internal" href="compile_android10.0_firmware.html">4. Compile Android10.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="customize_android_firmware.html">5. Customized Android firmware</a></li>
</ul>
<p class="caption"><span class="caption-text">Other</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="uboot_introduction.html">U-Boot</a></li>
</ul>
<p class="caption"><span class="caption-text">Driver</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="driver_adc.html">ADC</a></li>
<li class="toctree-l1"><a class="reference internal" href="driver_gpio.html">GPIO</a></li>
<li class="toctree-l1"><a class="reference internal" href="driver_i2c.html">I2C</a></li>
<li class="toctree-l1"><a class="reference internal" href="driver_ir.html">IR</a></li>
<li class="toctree-l1"><a class="reference internal" href="driver_lcd.html">LCD</a></li>
<li class="toctree-l1"><a class="reference internal" href="driver_led.html">LED</a></li>
<li class="toctree-l1"><a class="reference internal" href="driver_pwm.html">PWM</a></li>
<li class="toctree-l1"><a class="reference internal" href="driver_spi.html">SPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="driver_timer.html">TIMER</a></li>
<li class="toctree-l1"><a class="reference internal" href="driver_uart.html">UART</a></li>
</ul>
<p class="caption"><span class="caption-text">Accessories</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="module_serial.html">Conversion module</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_display.html">Screen module</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_camera.html">Camera Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_wireless.html">Wireless module</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_12V_adapter.html">Power adapter</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_ir.html">Remote control</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_cooling.html">Heat sink</a></li>
</ul>
<p class="caption"><span class="caption-text">Questions and answers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="faqs.html">FAQS</a></li>
</ul>
<p class="caption"><span class="caption-text">Hardware resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="hardware_doc.html">Related document</a></li>
</ul>

            

            
<style>
    .wy-menu-vertical a.download:hover{
        background: none;
    }
    .wy-menu-vertical a.download{

        padding: 0;
        color: #fff;

    }
</style>


<p class="caption">
    <a href="https://wiki.t-firefly.com/en/Firefly-Linux-Guide/index.html" target="_blank" class="download"><span class="caption-text">Firefly Linux User Guide</span></a>
</p>

<p class="caption">
    <a href="http://wiki.t-firefly.com/en/Firefly-Android-Manual/system_function.html" target="_blank" class="download"><span class="caption-text">Firefly Android User Manual</span></a>
</p>

<p class="caption">
    <a href="http://wiki.t-firefly.com/en/FireflyApi/FireflyApi.html" target="_blank" class="download"><span class="caption-text">FireflyApi</span></a>
</p>

<p class="caption">
    <a href=" ./download/en.t-firefly.com/doc/download/127.html" target="_blank" class="download"><span class="caption-text">Resource download</span></a>
</p>






          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">ROC-RK3399-PC Pro Manual</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<style>

    @media screen and (max-width: 1100px){
        .prodcut-show-main{
            display: none;
        }
    }
    .prodcut-show-main{
        background: #edf0f2;
        width: 100%;
        height: 170px;
        margin-bottom: 24px;
    }
    .prodcut-show-main .prodcut-show-main-left{
        width: 33%;
    }
    .prodcut-show-main .prodcut-show-main-right{
        width: 64%;
        margin-top: 36px;
        margin-right: 18px;
    }
    .prodcut-show-main .prodcut-show-main-right p{
        color: gray;
        font-size: 84%;
        height: 74px;
        overflow-x: hidden;
    }
    .product-show-name .fa-pull-left{
        
        font-size: 124%;
        color: #ff6600;
        font-weight: bolder;
        
    }
    .product-show-name{
        margin-bottom: 12px;
    }
    .product-show-name .fa-pull-right a{
        
        background: #ff6600;
        color: white;
        padding: 6px 16px;
        border-radius: 4px;
        font-size: 80%;
        margin-left: 10px;

    }
    .prodcut-show-img{
        height: 170px;
	width: 100%;
    	display: flex;
    	justify-content: center;
    	align-items: center;
    }
    
</style>

<div class="prodcut-show-main clearfix">
    <div class="fa-pull-left prodcut-show-main-left">
        <div class="prodcut-show-img">
            <img src="../../../en.t-firefly.com/upload/portal/20211215/169f38798b9bd74f729d3a37766fa3b2.png" alt="">
        </div>
    </div>
    <div class="fa-pull-right prodcut-show-main-right">
        <div class="product-show-name clearfix">
            <div class="fa-pull-left ">
                ROC-RK3399-PC Pro <span></span>
            </div>

            <div class="fa-pull-right">
                
                <a href="hhttps://download.t-firefly.com/product/Board/RK3399/Document/Hardware/ROC-RK3399-PC%20Pro/Specification/ROC-RK3399-PC%20Pro%20Specification.pdf" target="_blank">Spec</a>
                

                

                
            </div>
        </div>

        <p>ROC-RK3399-PC Pro uses RK3399 6-core (A72x2+A53x4) 64-bit processor with a main frequency of up to 1.8GHz. It integrates four-core Mali-T860 GPU with excellent performance.</p>
    </div>
</div>



<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Firefly Ubuntu User Manual</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/ubuntu_manual.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="firefly-ubuntu-user-manual">
<h1>Firefly Ubuntu User Manual<a class="headerlink" href="#firefly-ubuntu-user-manual" title="Permalink to this headline">¶</a></h1>
<p>This user manual is applicable to Firefly Ubuntu Desktop &amp; Minimal system. Some introductions related to UI display are only for Desktop system.</p>
<p><strong>It is strongly recommended to use Ubuntu 18.04. If you use other versions of the system, some sections of this document may not be fully applicable.</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="linux_build_ubuntu_rootfs.html"><span class="doc">Create  Ubuntu root file system</span></a></p></li>
<li><p><a class="reference internal" href="linux_compile_gpt.html"><span class="doc">“Compile Ubuntu firmware(GPT)”</span></a></p></li>
</ul>
<div class="section" id="adb-use">
<h2>ADB use<a class="headerlink" href="#adb-use" title="Permalink to this headline">¶</a></h2>
<div class="section" id="adb">
<h3>ADB<a class="headerlink" href="#adb" title="Permalink to this headline">¶</a></h3>
<p>ROC-RK3399-PC Pro use Type-C data cable to connect the device and the PC host;</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">adb</span> <span class="n">devices</span>
<span class="n">adb</span> <span class="n">shell</span>
</pre></div>
</div>
</div>
<div class="section" id="network-adb">
<h3>Network ADB<a class="headerlink" href="#network-adb" title="Permalink to this headline">¶</a></h3>
<p>Check the IP address of the development board, the PC end is accessed through the network:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">adb</span> <span class="n">connect</span> <span class="o">+</span> <span class="n">IP</span>
<span class="n">adb</span> <span class="n">shell</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="install-linux-headers-and-linux-image">
<h2>Install linux-headers and linux-image<a class="headerlink" href="#install-linux-headers-and-linux-image" title="Permalink to this headline">¶</a></h2>
<p>DEBIAN package download link:
<a class="reference external" href="https://drive.google.com/drive/folders/1FR_2-kTZ08xvFGc2a6vcvxG0TJAIN8G2?usp=sharing">Downloads</a></p>
<p>Install header files</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">dpkg</span> <span class="o">-</span><span class="n">i</span> <span class="n">linux</span><span class="o">-</span><span class="n">headers</span><span class="o">-</span><span class="mf">4.4</span><span class="o">.</span><span class="mi">194</span><span class="o">+</span><span class="n">_4</span><span class="o">.</span><span class="mf">4.194</span><span class="o">+-</span><span class="mi">5</span><span class="n">_arm64</span><span class="o">.</span><span class="n">deb</span>
<span class="n">sudo</span> <span class="n">dpkg</span> <span class="o">-</span><span class="n">i</span> <span class="n">linux</span><span class="o">-</span><span class="n">image</span><span class="o">-</span><span class="mf">4.4</span><span class="o">.</span><span class="mi">194</span><span class="o">+</span><span class="n">_4</span><span class="o">.</span><span class="mf">4.194</span><span class="o">+-</span><span class="mi">5</span><span class="n">_arm64</span><span class="o">.</span><span class="n">deb</span>

<span class="n">cd</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">linux</span><span class="o">-</span><span class="n">headers</span><span class="o">-</span><span class="mf">4.4</span><span class="o">.</span><span class="mi">194</span><span class="o">+</span>
<span class="n">make</span> <span class="n">headers_check</span>
<span class="n">make</span> <span class="n">headers_install</span>

<span class="c1">#make scripts It might go wrong but it doesn&#39;t matter</span>
<span class="n">make</span> <span class="n">scripts</span>
</pre></div>
</div>
</div>
<div class="section" id="qt-cross-compilation-environment-support">
<h2>Qt cross compilation environment support<a class="headerlink" href="#qt-cross-compilation-environment-support" title="Permalink to this headline">¶</a></h2>
<p>The Qt cross-compilation tool chain released by Firefly is suitable for the following environments:</p>
<ul class="simple">
<li><p>Host: x86-64 / Ubuntu 18.04</p></li>
<li><p>Target: Firefly RK3399 RK3328 PX30 / Ubuntu 18.04 Minimal&amp;Desktop</p></li>
</ul>
<p>The tool chain fully supports wenEngine and backends such as EGLFS LinuxFB XCB.</p>
<ul class="simple">
<li><p>download link</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Link: https://drive.google.com/drive/folders/1sQdnuZe2onTxvguUUV0LeVsOGWXb-d_q?usp=sharing
</pre></div>
</div>
<ul class="simple">
<li><p>Deployment</p></li>
</ul>
<p><strong>See Qt5.12.2_Release.md for details</strong>
Note that the names of all paths in the document cannot be changed, otherwise it will cause compilation or running errors.</p>
<ul class="simple">
<li><p>Compile</p></li>
</ul>
<p>On the host side, enter the Qt project directory, qmake &amp;&amp; make.</p>
<ul class="simple">
<li><p>Run</p></li>
</ul>
<p>Two test demos are provided in the tool chain, corresponding to EGLFS and LinuxFB Backend. After the deployment is completed, the user can build the demo on the host side and run the demo on the tartget side to test whether the deployment is successful.</p>
</div>
<div class="section" id="change-the-device-boot-and-desktop-logo">
<h2>Change the device boot and desktop LOGO<a class="headerlink" href="#change-the-device-boot-and-desktop-logo" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Boot up LOGO
The boot logo is stored in the SDK/kernel. After modification, recompile the kernel.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">linux</span><span class="o">-</span><span class="n">sdk</span><span class="o">/</span><span class="n">kenel</span><span class="o">/</span><span class="n">logo</span><span class="o">.</span><span class="n">bmp</span>
</pre></div>
</div>
<ul class="simple">
<li><p>LOGO on the desktop
After the replacement, restart the system.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/usr/share/lubuntu/
├── images
│   └── lubuntu-ff-logo.png             #Small icon in the upper left corner of the desktop
└── wallpapers
    └── firefly-default-wallpaper.png   #desktop wallpaper
</pre></div>
</div>
</div>
<div class="section" id="create-wifi-hotspot">
<h2>Create WIFI hotspot<a class="headerlink" href="#create-wifi-hotspot" title="Permalink to this headline">¶</a></h2>
<p>Hardware requirements:</p>
<ul class="simple">
<li><p>Requires wireless network card and supports mobile hotspot function</p></li>
</ul>
<p>Click the <code class="docutils literal notranslate"><span class="pre">Ethernet</span> <span class="pre">Network</span></code> icon in the upper right corner of the desktop, select <code class="docutils literal notranslate"><span class="pre">Edit</span> <span class="pre">Connection...</span></code>
<img alt="_images/Hostspot1.png" src="_images/Hostspot1.png" /></p>
<p>Select the <code class="docutils literal notranslate"><span class="pre">+</span></code> icon, Add a new connection
<img alt="_images/Hostspot2.png" src="_images/Hostspot2.png" /></p>
<p>Select <code class="docutils literal notranslate"><span class="pre">Wi-Fi</span></code>, then click <code class="docutils literal notranslate"><span class="pre">Create</span></code>
<img alt="_images/Hostspot3.png" src="_images/Hostspot3.png" /></p>
<p>Wi-Fi settings:</p>
<ul class="simple">
<li><p>Set SSID</p></li>
<li><p>Mode: select Hotspot</p></li>
<li><p>Device: select wireless network card (wlan)
<img alt="_images/Hostspot4.png" src="_images/Hostspot4.png" /></p></li>
</ul>
<p>Choose the appropriate encryption method:
<img alt="_images/Hostspot5.png" src="_images/Hostspot5.png" /></p>
<p>Click <code class="docutils literal notranslate"><span class="pre">Save</span></code> <strong>to complete the hotspot creation immediately</strong></p>
</div>
<div class="section" id="set-static-ip-using-netplan">
<h2>Set static IP (using netplan)<a class="headerlink" href="#set-static-ip-using-netplan" title="Permalink to this headline">¶</a></h2>
<p>Set static IP with netplan</p>
<ul class="simple">
<li><p>addresses</p></li>
<li><p>gateway4</p></li>
<li><p>nameservers： DNS nameservers</p></li>
<li><p>ethernets</p></li>
<li><p>wifis</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># vim /etc/netplan/netplan.yaml</span>
<span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># netplan apply</span>
</pre></div>
</div>
<p>The contents of netplan are as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">network</span><span class="p">:</span>
    <span class="n">ethernets</span><span class="p">:</span>
        <span class="n">eth0</span><span class="p">:</span>
            <span class="n">addresses</span><span class="p">:</span> <span class="p">[</span><span class="mf">168.168</span><span class="o">.</span><span class="mf">4.3</span><span class="o">/</span><span class="mi">24</span><span class="p">]</span>
            <span class="n">gateway4</span><span class="p">:</span> <span class="mf">168.168</span><span class="o">.</span><span class="mf">0.1</span>
            <span class="n">dhcp4</span><span class="p">:</span> <span class="n">yes</span>
            <span class="n">optional</span><span class="p">:</span> <span class="n">true</span>
    <span class="n">wifis</span><span class="p">:</span>
        <span class="n">wlan0</span><span class="p">:</span>
            <span class="n">addresses</span><span class="p">:</span> <span class="p">[</span><span class="mf">168.168</span><span class="o">.</span><span class="mf">4.23</span><span class="o">/</span><span class="mi">24</span><span class="p">]</span>
            <span class="n">gateway4</span><span class="p">:</span> <span class="mf">168.168</span><span class="o">.</span><span class="mf">0.1</span>
            <span class="n">dhcp4</span><span class="p">:</span> <span class="n">yes</span>
            <span class="n">dhcp6</span><span class="p">:</span> <span class="n">no</span>
            <span class="n">access</span><span class="o">-</span><span class="n">points</span><span class="p">:</span>
            <span class="s2">&quot;ssid&quot;</span><span class="p">:</span>
                <span class="n">password</span><span class="p">:</span> <span class="s2">&quot;password&quot;</span>
    <span class="n">version</span><span class="p">:</span> <span class="mi">2</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">network</span><span class="p">:</span>
    <span class="n">ethernets</span><span class="p">:</span>
        <span class="n">eth0</span><span class="p">:</span>
            <span class="n">addresses</span><span class="p">:</span> <span class="p">[</span><span class="mf">168.168</span><span class="o">.</span><span class="mf">4.3</span><span class="o">/</span><span class="mi">24</span><span class="p">]</span>
            <span class="n">gateway4</span><span class="p">:</span> <span class="mf">168.168</span><span class="o">.</span><span class="mf">0.1</span>
            <span class="n">dhcp4</span><span class="p">:</span> <span class="n">no</span>
            <span class="n">optional</span><span class="p">:</span> <span class="n">true</span>
            <span class="n">nameservers</span><span class="p">:</span>
              <span class="n">addresses</span><span class="p">:</span> <span class="p">[</span><span class="mf">202.96</span><span class="o">.</span><span class="mf">128.166</span><span class="p">]</span>
    <span class="n">wifis</span><span class="p">:</span>
        <span class="n">wlan0</span><span class="p">:</span>
            <span class="n">addresses</span><span class="p">:</span> <span class="p">[</span><span class="mf">168.168</span><span class="o">.</span><span class="mf">4.23</span><span class="o">/</span><span class="mi">24</span><span class="p">]</span>
            <span class="n">gateway4</span><span class="p">:</span> <span class="mf">168.168</span><span class="o">.</span><span class="mf">0.1</span>
            <span class="n">dhcp4</span><span class="p">:</span> <span class="n">no</span>
            <span class="n">dhcp6</span><span class="p">:</span> <span class="n">no</span>
            <span class="n">access</span><span class="o">-</span><span class="n">points</span><span class="p">:</span>
            <span class="s2">&quot;ssid&quot;</span><span class="p">:</span>
                <span class="n">password</span><span class="p">:</span> <span class="s2">&quot;password&quot;</span>
    <span class="n">version</span><span class="p">:</span> <span class="mi">2</span>
</pre></div>
</div>
<p>More configuration examples for netplan: <a class="reference external" href="https://netplan.io/examples">https://netplan.io/examples</a></p>
</div>
<div class="section" id="usb-ethernet">
<h2>USB Ethernet<a class="headerlink" href="#usb-ethernet" title="Permalink to this headline">¶</a></h2>
<p>USB Ethernet, the main realization is to use the OTG interface of the device as a peripheral mode and simulate it as a network interface, and then the host connects to the device via USB and accesses the Internet through the device. The following is the specific operation based on Firefly-RK3399 device.</p>
<p>Operating environment:</p>
<ul class="simple">
<li><p>PC with Ubuntu system</p></li>
<li><p>Firefly-RK3399 device</p></li>
</ul>
<div class="section" id="kernel-settings">
<h3>Kernel Settings<a class="headerlink" href="#kernel-settings" title="Permalink to this headline">¶</a></h3>
<p>In the kernel directory, open the kernel configuration options menu:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">firefly_linux_defconfig</span>
<span class="n">make</span> <span class="n">menuconfig</span>
</pre></div>
</div>
<p>After entering the kernel configuration menu, select in turn: <code class="docutils literal notranslate"><span class="pre">Device</span> <span class="pre">Drivers</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">USB</span> <span class="pre">Support</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">USB</span> <span class="pre">Gadget</span> <span class="pre">Support</span></code>.</p>
<p>Set the <code class="docutils literal notranslate"><span class="pre">USB</span> <span class="pre">Gadget</span> <span class="pre">Driver</span></code> to compile into a module, and then you can find the option of <code class="docutils literal notranslate"><span class="pre">Ethernet</span> <span class="pre">Gadget</span> <span class="pre">(with</span> <span class="pre">CDC</span> <span class="pre">Ethernet</span> <span class="pre">support)</span></code> below, and choose to compile into a module as well. At the same time, select <code class="docutils literal notranslate"><span class="pre">RNDIS</span> <span class="pre">support</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;</span> <span class="n">USB</span> <span class="n">Gadget</span> <span class="n">Drivers</span>
<span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;</span> <span class="n">USB</span> <span class="n">functions</span> <span class="n">configurable</span> <span class="n">through</span> <span class="n">configfs</span>
<span class="o">&lt;</span><span class="n">M</span><span class="o">&gt;</span> <span class="n">Ethernet</span> <span class="n">Gadget</span> <span class="p">(</span><span class="k">with</span> <span class="n">CDC</span> <span class="n">Ethernet</span> <span class="n">support</span><span class="p">)</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">RNDIS</span> <span class="n">support</span> <span class="p">(</span><span class="n">NEW</span><span class="p">)</span>
</pre></div>
</div>
<p>Then compile the kernel in the <code class="docutils literal notranslate"><span class="pre">kernel</span></code> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">rk3399</span><span class="o">-</span><span class="n">firefly</span><span class="o">.</span><span class="n">img</span> <span class="o">-</span><span class="n">j12</span>
</pre></div>
</div>
<p>After the compilation is completed, burn the kernel to the device. For the burn process, please refer to the partition image burning part in the Wiki tutorial: <a class="reference internal" href="03-upgrade_firmware.html"><span class="doc">Upgrade Firmware</span></a>. Then copy the following modules generated in the kernel directory to the device:</p>
<ul class="simple">
<li><p>drivers/usb/gadget/function/u_ether.ko</p></li>
<li><p>drivers/usb/gadget/function/usb_f_ecm_subset.ko</p></li>
<li><p>drivers/usb/gadget/function/usb_f_ecm.ko</p></li>
<li><p>drivers/usb/gadget/function/usb_f_rndis.ko</p></li>
<li><p>drivers/usb/gadget/function/usb_f_eem.ko</p></li>
<li><p>drivers/usb/gadget/legacy/g_ether.ko</p></li>
<li><p>drivers/usb/gadget/libcomposite.ko</p></li>
</ul>
<p>Then on the device, load the above modules in sequence:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">insmod</span> <span class="n">libcomposite</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="n">u_ether</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="n">usb_f_ecm_subset</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="n">usb_f_rndis</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="n">usb_f_ecm</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="n">usb_f_eem</span><span class="o">.</span><span class="n">ko</span>
<span class="n">insmod</span> <span class="n">g_ether</span><span class="o">.</span><span class="n">ko</span>
</pre></div>
</div>
<p><strong>Note:</strong> You must load <code class="docutils literal notranslate"><span class="pre">libcomposite.ko</span></code> and <code class="docutils literal notranslate"><span class="pre">u_ether.ko</span></code> first, and then the following modules can be loaded.</p>
</div>
<div class="section" id="ip-address-settings">
<h3>IP address settings<a class="headerlink" href="#ip-address-settings" title="Permalink to this headline">¶</a></h3>
<p>Connect the PC and the OTG interface of the device with a data cable, and execute the <code class="docutils literal notranslate"><span class="pre">lsusb</span></code> command in the PC to view the USB Ethernet device, which means the connection is successful.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>firefly@Desktop:~$ lsusb
Bus 002 Device 003: ID 09da:5814 A4Tech Co., Ltd.
Bus 002 Device 002: ID 8087:0024 Intel Corp. Integrated Rate Matching Hub
Bus 002 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 001 Device 005: ID 04f2:b2ea Chicony Electronics Co., Ltd Integrated Camera [ThinkPad]
Bus 001 Device 004: ID 0a5c:21e6 Broadcom Corp. BCM20702 Bluetooth 4.0 [ThinkPad]
Bus 001 Device 003: ID 147e:1002 Upek Biometric Touchchip/Touchstrip Fingerprint Sensor
Bus 001 Device 002: ID 8087:0024 Intel Corp. Integrated Rate Matching Hub
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
Bus 004 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 003 Device 003: ID 0525:a4a2 Netchip Technology, Inc. Linux-USB Ethernet/RNDIS Gadget
Bus 003 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
</pre></div>
</div>
<p>ID 0525:a4a2 Netchip Technology, Inc. Linux-USB Ethernet/RNDIS Gadget in the output information is the USB network card device.</p>
<p>The device is plugged into the network cable so that the device can connect to the external network.</p>
<ul class="simple">
<li><p>IP settings in the device:</p></li>
</ul>
<p>Enter and execute the <code class="docutils literal notranslate"><span class="pre">ifconfig</span> <span class="pre">-a</span></code> command, you can see the following information:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># ifconfig -a</span>

<span class="c1"># eth0 is the wired network card</span>
<span class="n">eth0</span><span class="p">:</span> <span class="n">flags</span><span class="o">=</span><span class="mi">4163</span><span class="o">&lt;</span><span class="n">UP</span><span class="p">,</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">RUNNING</span><span class="p">,</span><span class="n">MULTICAST</span><span class="o">&gt;</span> <span class="n">mtu</span> <span class="mi">1500</span>
        <span class="n">inet</span> <span class="mf">168.168</span><span class="o">.</span><span class="mf">100.48</span> <span class="n">netmask</span> <span class="mf">255.255</span><span class="o">.</span><span class="mf">0.0</span> <span class="n">broadcast</span> <span class="mf">168.168</span><span class="o">.</span><span class="mf">255.255</span>
        <span class="n">inet6</span> <span class="n">fe80</span><span class="p">::</span><span class="mi">1351</span><span class="p">:</span><span class="n">ae2f</span><span class="p">:</span><span class="mi">442</span><span class="n">e</span><span class="p">:</span><span class="n">e436</span> <span class="n">prefixlen</span> <span class="mi">64</span> <span class="n">scopeid</span> <span class="mh">0x20</span><span class="o">&lt;</span><span class="n">link</span><span class="o">&gt;</span>
        <span class="n">ether</span> <span class="mi">8</span><span class="n">a</span><span class="p">:</span><span class="mi">4</span><span class="n">f</span><span class="p">:</span><span class="n">c3</span><span class="p">:</span><span class="mi">77</span><span class="p">:</span><span class="mi">94</span><span class="p">:</span><span class="n">ac</span> <span class="n">txqueuelen</span> <span class="mi">1000</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">packets</span> <span class="mi">9759</span> <span class="nb">bytes</span> <span class="mi">897943</span> <span class="p">(</span><span class="mf">897.9</span> <span class="n">KB</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">errors</span> <span class="mi">0</span> <span class="n">dropped</span> <span class="mi">0</span> <span class="n">overruns</span> <span class="mi">0</span> <span class="n">frame</span> <span class="mi">0</span>
        <span class="n">TX</span> <span class="n">packets</span> <span class="mi">236</span> <span class="nb">bytes</span> <span class="mi">35172</span> <span class="p">(</span><span class="mf">35.1</span> <span class="n">KB</span><span class="p">)</span>
        <span class="n">TX</span> <span class="n">errors</span> <span class="mi">0</span> <span class="n">dropped</span> <span class="mi">0</span> <span class="n">overruns</span> <span class="mi">0</span> <span class="n">carrier</span> <span class="mi">0</span> <span class="n">collisions</span> <span class="mi">0</span>
        <span class="n">device</span> <span class="n">interrupt</span> <span class="mi">42</span> <span class="n">base</span> <span class="mh">0x8000</span>

        <span class="o">...</span>

<span class="c1"># usb0 is a virtual usb network card</span>
<span class="n">usb0</span><span class="p">:</span> <span class="n">flags</span><span class="o">=</span><span class="mi">4098</span><span class="o">&lt;</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="o">&gt;</span> <span class="n">mtu</span> <span class="mi">1500</span>
        <span class="n">ether</span> <span class="mi">4</span><span class="n">a</span><span class="p">:</span><span class="mi">81</span><span class="p">:</span><span class="n">b1</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="n">d2</span><span class="p">:</span><span class="n">ad</span> <span class="n">txqueuelen</span> <span class="mi">1000</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">packets</span> <span class="mi">0</span> <span class="nb">bytes</span> <span class="mi">0</span> <span class="p">(</span><span class="mf">0.0</span> <span class="n">B</span><span class="p">)</span>
        <span class="n">RX</span> <span class="n">errors</span> <span class="mi">0</span> <span class="n">dropped</span> <span class="mi">0</span> <span class="n">overruns</span> <span class="mi">0</span> <span class="n">frame</span> <span class="mi">0</span>
        <span class="n">TX</span> <span class="n">packets</span> <span class="mi">0</span> <span class="nb">bytes</span> <span class="mi">0</span> <span class="p">(</span><span class="mf">0.0</span> <span class="n">B</span><span class="p">)</span>
        <span class="n">TX</span> <span class="n">errors</span> <span class="mi">0</span> <span class="n">dropped</span> <span class="mi">0</span> <span class="n">overruns</span> <span class="mi">0</span> <span class="n">carrier</span> <span class="mi">0</span> <span class="n">collisions</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Then customize an appropriate IP for the usb0 network card:</p>
<p>Note that the IP of usb0 and the IP of wired network card eth0 are not in the same network segment! !</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ifconfig</span> <span class="n">usb0</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.101</span>
</pre></div>
</div>
<ul class="simple">
<li><p>IP setting in PC:</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># First check the USB virtual network card
firefly@Desktop:~$ ifconfig
enp0s20u2i1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500
        inet 192.168.2.90 netmask 255.255.255.0 broadcast 192.168.2.255
        inet6 fe80::871c:b87e:1327:7fd4 prefixlen 64 scopeid 0x20&lt;link&gt;
        ether 46:fe:6e:97:ee:a6 txqueuelen 1000 (Ethernet)
        RX packets 0 bytes 0 (0.0 B)
        RX errors 0 dropped 0 overruns 0 frame 0
        TX packets 1 bytes 54 (54.0 B)
        TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0
...

# Set the USB network card&#39;s IP address and the device&#39;s usb0 IP address in the same network segment
firefly@Desktop:~$ sudo ifconfig enp0s20u2i1 192.168.1.100

#Set the default gateway: it should be set to the ip address of the device usb0, because the traffic will be forwarded through usb0 later
firefly@Desktop:~$ sudo route add default gw 192.168.1.101
</pre></div>
</div>
<p>After setting the IP of the device and the PC, they can ping each other, and the PC can also use the <code class="docutils literal notranslate"><span class="pre">ssh</span></code> command to log in to the device.</p>
</div>
<div class="section" id="network-sharing-to-realize-pc-internet-access">
<h3>Network sharing to realize PC Internet access<a class="headerlink" href="#network-sharing-to-realize-pc-internet-access" title="Permalink to this headline">¶</a></h3>
<p>On the device: First turn on the IPv4 forwarding function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">ipv4</span><span class="o">/</span><span class="n">ip_forward</span>
</pre></div>
</div>
<p>If you want to automatically turn on the forwarding function every time you restart the device, please directly modify the value of <code class="docutils literal notranslate"><span class="pre">net.ipv4.ip_forward</span></code> in the <code class="docutils literal notranslate"><span class="pre">/etc/sysctl.conf</span></code> file to 1. After modifying the file parameters, execute the <code class="docutils literal notranslate"><span class="pre">sysctl</span> <span class="pre">-p</span></code> command to reload the <code class="docutils literal notranslate"><span class="pre">/etc/sysctl.conf</span></code> file to make the IPv4 forwarding function effective.</p>
<p>Add rules for traffic forwarding:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">iptables</span> <span class="o">-</span><span class="n">t</span> <span class="n">nat</span> <span class="o">-</span><span class="n">A</span> <span class="n">POSTROUTING</span> <span class="o">-</span><span class="n">s</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">24</span> <span class="o">-</span><span class="n">o</span> <span class="n">eth0</span> <span class="o">-</span><span class="n">j</span> <span class="n">SNAT</span> <span class="o">--</span><span class="n">to</span><span class="o">-</span><span class="n">source</span> <span class="mf">168.168</span><span class="o">.</span><span class="mf">100.48</span>
</pre></div>
</div>
<p>Now the host PC can access the network. If the PC can ping the usb0 and eth0 of the device, but cannot access the Internet, you need to modify the DNS of the PC and add the following in <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nameserver</span> <span class="mf">8.8</span><span class="o">.</span><span class="mf">8.8</span>
<span class="n">nameserver</span> <span class="mf">8.8</span><span class="o">.</span><span class="mf">4.4</span>
</pre></div>
</div>
<p>Pay attention to the following points during the configuration process:</p>
<ul class="simple">
<li><p>Correspond to each IP address on your device in the above steps, and note that the USB virtual network card IP and wired network IP on the device are not in the same network segment;</p></li>
<li><p>The gateway of the PC virtual USB network card should be set to the IP address of the device virtual USB network card;</p></li>
<li><p>The virtual network card IP address, IP forwarding function, traffic forwarding rules and other settings on the device will be restored after the device is restarted. The user can find out the information on how to automatically set these configurations after booting.</p></li>
</ul>
</div>
</div>
<div class="section" id="export-device-system">
<h2>Export device system<a class="headerlink" href="#export-device-system" title="Permalink to this headline">¶</a></h2>
<p>This chapter applies to:
When the user has completed the deployment of the work environment on one device, the current environment needs to be completely exported for batch deployment to other devices on the same platform.Users can also backup the current development environment by exporting the device file system.</p>
<ul class="simple">
<li><p><a class="reference internal" href="export_dev_sf.html"><span class="doc">“Export device system”</span></a></p></li>
</ul>
</div>
<div class="section" id="screen-rotation">
<h2>Screen rotation<a class="headerlink" href="#screen-rotation" title="Permalink to this headline">¶</a></h2>
<p>Firefly Ubuntu Desktop uses the ff_rotate script to control screen rotation:</p>
<ul class="simple">
<li><p>ff_rotate</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># ff_rotate</span>

        <span class="n">rotate</span> <span class="n">screen</span> <span class="ow">and</span> <span class="n">touchscreen</span>
                <span class="n">run</span> <span class="k">as</span> <span class="n">root</span>
                <span class="n">ff_rotate</span> <span class="o">&lt;</span><span class="n">orientation</span><span class="o">&gt;</span>
                        <span class="n">orientation</span><span class="p">:</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">normal</span><span class="p">,</span> <span class="n">inverted</span>
<span class="c1">#Image output flip</span>
<span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># ff_rotate inverted</span>
</pre></div>
</div>
</div>
<div class="section" id="display-version-information">
<h2>Display version information<a class="headerlink" href="#display-version-information" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>ffgo</p></li>
</ul>
<p>The ffgo command provided by Firefly can easily view the firmware information, which is convenient for developers to debug and locate problems.</p>
<p>When users need to feedback information to Firefly, they need to attach the version information displayed by ffgo version.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># ffgo</span>
<span class="n">Usage</span><span class="p">:</span>
         <span class="n">ffgo</span><span class="p">:</span> <span class="n">show</span> <span class="n">this</span> <span class="n">usage</span>
         <span class="n">ffgo</span> <span class="n">update</span><span class="p">:</span> <span class="n">update</span> <span class="n">ffgo</span>
         <span class="n">ffgo</span> <span class="n">version</span><span class="p">:</span> <span class="n">get</span> <span class="n">version</span>
         <span class="n">ffgo</span> <span class="n">cmdlist</span><span class="p">:</span> <span class="n">get</span> <span class="n">support</span> <span class="n">cmd</span> <span class="nb">list</span>
         <span class="n">ffgo</span> <span class="p">[</span><span class="n">cmd</span><span class="p">]:</span> <span class="n">run</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmd</span> <span class="nb">list</span>

<span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># ffgo update</span>
<span class="n">update</span> <span class="n">success</span>
<span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># ffgo version</span>
<span class="n">OS</span><span class="p">:</span> <span class="n">Ubuntu</span> <span class="mf">18.04</span><span class="o">.</span><span class="mi">4</span> <span class="n">LTS</span>
<span class="n">MODEL</span><span class="p">:</span> <span class="n">Firefly</span><span class="o">-</span><span class="n">RK3399</span> <span class="n">Board</span> <span class="p">(</span><span class="n">Linux</span> <span class="n">Opensource</span><span class="p">)</span>
<span class="n">FIREFLY</span><span class="p">:</span> <span class="n">v2</span><span class="o">.</span><span class="mi">03</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">g2ed565c</span>
<span class="n">DATE</span><span class="p">:</span> <span class="mi">20200617</span><span class="o">-</span><span class="mi">1042</span>
<span class="n">KERNEL</span><span class="p">:</span> <span class="n">Linux</span> <span class="n">version</span> <span class="mf">4.4</span><span class="o">.</span><span class="mi">194</span><span class="o">-</span><span class="mi">59119</span><span class="o">-</span><span class="n">g968ba5005831</span> <span class="p">(</span><span class="n">jincheng</span><span class="nd">@jincheng</span><span class="o">-</span><span class="n">System</span><span class="o">-</span><span class="n">Product</span><span class="o">-</span><span class="n">Name</span><span class="p">)</span> <span class="p">(</span><span class="n">local</span><span class="o">/</span><span class="n">firefly</span><span class="o">-</span><span class="n">linux</span><span class="o">/</span><span class="n">rk3399</span><span class="o">/</span><span class="n">firefly</span><span class="p">:</span> <span class="mi">968</span><span class="n">ba5005831c5f69d68d95984451fd2a7c457c0</span><span class="p">)</span> <span class="p">(</span><span class="n">gcc</span> <span class="n">version</span> <span class="mf">6.3</span><span class="o">.</span><span class="mi">1</span> <span class="mi">20170404</span> <span class="p">(</span><span class="n">Lina0</span>
</pre></div>
</div>
</div>
<div class="section" id="reset">
<h2>reset<a class="headerlink" href="#reset" title="Permalink to this headline">¶</a></h2>
<p>Firefly Ubuntu supports restoring factory settings.
<strong>Note that this factory setting means that the device is restored to its initial state after the last firmware upgrade</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># recovery</span>
<span class="n">Usage</span><span class="p">:</span> <span class="n">update</span> <span class="o">&lt;</span><span class="n">option</span><span class="o">&gt;</span>

<span class="n">Options</span> <span class="n">are</span><span class="p">:</span>
        <span class="n">ota</span> <span class="o">|</span> <span class="n">update</span> <span class="p">[</span><span class="n">path</span><span class="p">]:</span>
                <span class="n">update</span> <span class="n">firmware</span><span class="p">,</span> <span class="k">if</span> <span class="n">no</span> <span class="n">path</span><span class="p">,</span> <span class="n">use</span> <span class="n">default</span> <span class="n">path</span>
                <span class="s2">&quot;/userdata/update.img&quot;</span>
                <span class="s2">&quot;/sdcard/update.img&quot;</span>
        <span class="n">factory</span> <span class="o">|</span> <span class="n">reset</span><span class="p">:</span>
                <span class="n">reset</span> <span class="n">to</span> <span class="n">factory</span>
</pre></div>
</div>
<p>Use <code class="docutils literal notranslate"><span class="pre">recovery</span> <span class="pre">reset</span></code> to restore to factory settings</p>
</div>
<div class="section" id="startup-program">
<h2>Startup program<a class="headerlink" href="#startup-program" title="Permalink to this headline">¶</a></h2>
<p>Firefly Ubuntu Desktop can use the following methods to set the boot-up program, but you need to pay attention to the operating permissions and current environment variables:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$vim /home/firefly/.config/lxsession/Lubuntu/autostart
@/bin/mkdir /home/firefly/ssddd
</pre></div>
</div>
<p>Each command starts with <code class="docutils literal notranslate"><span class="pre">&#64;</span></code>, and the above example will create the <code class="docutils literal notranslate"><span class="pre">/home/firefly/ssddd</span></code> directory</p>
</div>
<div class="section" id="use-root-to-log-in-to-the-system-interface">
<h2>Use root to log in to the system interface<a class="headerlink" href="#use-root-to-log-in-to-the-system-interface" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>autologin-user=root</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># cat /etc/lightdm/lightdm.conf.d/20-autologin.conf</span>
<span class="p">[</span><span class="n">Seat</span><span class="p">:</span><span class="o">*</span><span class="p">]</span>
<span class="n">user</span><span class="o">-</span><span class="n">session</span><span class="o">=</span><span class="n">Lubuntu</span>
<span class="n">autologin</span><span class="o">-</span><span class="n">user</span><span class="o">=</span><span class="n">root</span>
</pre></div>
</div>
</div>
<div class="section" id="video-hardware-codec-support">
<h2>Video hardware codec support<a class="headerlink" href="#video-hardware-codec-support" title="Permalink to this headline">¶</a></h2>
<p>The integrated VPU of RK3399 has excellent video codec capabilities. Mpp is a set of video codec APIs provided by Rockchip for VPU, and is based on mpp. Rockchip provides a set of gstreamer codec plug-ins. Users can do video codec applications based on gstreamer according to their needs, or directly call mpp to achieve hardware codec acceleration.</p>
<p>The system provides a test video file located at /usr/local/test.mp4, the test file is 1080P, 24Fps, H264 encoding, Mp4 format.</p>
<p>There are several ways to verify and develop video codec related applications.</p>
<div class="section" id="gstreamer">
<h3>Gstreamer<a class="headerlink" href="#gstreamer" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Under Ubuntu 16.04, gstreamer 1.12 has been installed in the /opt/ directory.</p></li>
<li><p>Under Ubuntu 18.04, gstreamer 1.12 has been installed in the system.</p></li>
</ul>
<p>/usr/local/bin/h264dec.sh Test hardware H264 decoding.</p>
<p>/usr/local/bin/h264enc.sh Test hardware H264 encoding.</p>
<p>Users can refer to these two scripts to configure their own gstreamer application.</p>
</div>
<div class="section" id="mpv">
<h3>Mpv<a class="headerlink" href="#mpv" title="Permalink to this headline">¶</a></h3>
<p>The Mpv player provided by the system can directly call the rkmpp decoding plug-in.</p>
</div>
<div class="section" id="ffmpeg">
<h3>FFmpeg<a class="headerlink" href="#ffmpeg" title="Permalink to this headline">¶</a></h3>
<p>FFmpeg only supports hardware decoding through Mpp for Rockchip temporarily, and there is no hardware encoding support for the time being.</p>
<p>Firefly Ubuntu has installed FFmpeg, and users can use it directly.</p>
<p>-Confirm rkmpp decoder</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ ffmpeg -decoders <span class="p">|</span> grep <span class="s2">&quot;rkmpp&quot;</span>

 V..... h264_rkmpp h264 <span class="o">(</span>rkmpp<span class="o">)</span> <span class="o">(</span>codec h264<span class="o">)</span>
 V..... hevc_rkmpp hevc <span class="o">(</span>rkmpp<span class="o">)</span> <span class="o">(</span>codec hevc<span class="o">)</span>
 V..... vp8_rkmpp vp8 <span class="o">(</span>rkmpp<span class="o">)</span> <span class="o">(</span>codec vp8<span class="o">)</span>
 V..... vp9_rkmpp vp9 <span class="o">(</span>rkmpp<span class="o">)</span> <span class="o">(</span>codec vp9<span class="o">)</span>
</pre></div>
</div>
<p>-Test commands</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ ffmpeg -y -c:v h264_rkmpp -i test.mp4 -an  output.yuv
</pre></div>
</div>
<p><strong>Special attention:</strong> FFmpeg h264_rkmpp decodes AV_PIX_FMT_DRM_PRIME, which is DRM frame data. If it is based on drm display, you can directly output the frame, otherwise, you need to use hwdownload to convert.</p>
<p>For more information, please refer to <a class="reference external" href="http://ffmpeg.org/about.html">FFmpeg official website</a>.</p>
</div>
<div class="section" id="mpp">
<h3>Mpp<a class="headerlink" href="#mpp" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>Under Ubunut system, mpp related dev packages have been installed in the system.</p>
<p>For more related information, please refer to the relevant documents under <code class="docutils literal notranslate"><span class="pre">linux-sdk/docs/Linux/Multimedia</span></code></p>
</li>
</ul>
</div>
</div>
<div class="section" id="opengl-es">
<h2>OpenGL-ES<a class="headerlink" href="#opengl-es" title="Permalink to this headline">¶</a></h2>
<p>RK3399 supports OpenGL ES1.1/2.0/3.0/3.1.</p>
<p>Firefly Ubuntu has provided complete OpenGL-ES support.</p>
<p>-Test commands</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ sudo test_glmark2_normal.sh
</pre></div>
</div>
<p>-webGL support</p>
<p>In the Chromium browser, type in the address bar: <code class="docutils literal notranslate"><span class="pre">chrome://gpu</span></code> to view the hardware acceleration support under Chromium.</p>
<p>Note:</p>
<ol>
<li><p>EGL is an extension of OpenGL on the arm platform for the x window system, and its function is equivalent to the glx library under x86.</p></li>
<li><p>Because the Driver modesettings used by Xorg will load libglx.so by default (disabling glx will cause some applications that detect glx environment to fail to start), libglx.so will search for the dri implementation library in the system. However, rk3399 Xorg 2D acceleration is implemented directly based on DRM and does not implement the dri library, so during the startup process, libglx.so will report the following error.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">EE</span><span class="p">)</span> <span class="n">AIGLX</span> <span class="n">error</span><span class="p">:</span> <span class="n">dlopen</span> <span class="n">of</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">dri</span><span class="o">/</span><span class="n">rockchip_dri</span><span class="o">.</span><span class="n">so</span> <span class="n">failed</span>
</pre></div>
</div>
<p>This has no effect on the operation of the system and does not need to be processed.</p>
</li>
<li><p>Based on the same reasoning, some applications will report the following errors during the startup process, and there is no need to deal with them, which will not affect the operation of the application.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">libGL</span> <span class="n">error</span><span class="p">:</span> <span class="n">unable</span> <span class="n">to</span> <span class="n">load</span> <span class="n">driver</span><span class="p">:</span> <span class="n">rockchip_dri</span><span class="o">.</span><span class="n">so</span>
<span class="n">libGL</span> <span class="n">error</span><span class="p">:</span> <span class="n">driver</span> <span class="n">pointer</span> <span class="n">missing</span>
<span class="n">libGL</span> <span class="n">error</span><span class="p">:</span> <span class="n">failed</span> <span class="n">to</span> <span class="n">load</span> <span class="n">driver</span><span class="p">:</span> <span class="n">rockchip</span>
</pre></div>
</div>
</li>
<li><p>In some versions of Ubuntu software previously released by Firefly, the loading of libglx.so is disabled by default. In some cases, the following errors will occur when running certain applications:</p>
<p><code class="docutils literal notranslate"><span class="pre">GdkGLExt-WARNING</span> <span class="pre">**:</span> <span class="pre">Window</span> <span class="pre">system</span> <span class="pre">doesn't</span> <span class="pre">support</span> <span class="pre">OpenGL.</span></code></p>
<p>The correction method is as follows:</p>
<p>Delete the following three lines of configuration in <code class="docutils literal notranslate"><span class="pre">/etc/X11/xorg.conf.d/20-modesetting.conf</span></code>.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>Section <span class="s2">&quot;Module&quot;</span>
     Disable <span class="s2">&quot;glx&quot;</span>
EndSection
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="opencl">
<h2>OpenCL<a class="headerlink" href="#opencl" title="Permalink to this headline">¶</a></h2>
<p>Firefly Ubuntu has added opencl1.2 support, you can run the built-in <code class="docutils literal notranslate"><span class="pre">clinfo</span></code> of the system to get platform opencl related parameters.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>firefly@firefly:~$ clinfo
Platform #0
 Name: ARM Platform
 Version: OpenCL 1.2 v1.r14p0-01rel0-git(966ed26).f44c85cb3d2ceb87e8be88e7592755c3

 Device #0
   Name: Mali-T860
   Type: GPU
   Version: OpenCL 1.2 v1.r14p0-01rel0-git(966ed26).f44c85cb3d2ceb87e8be88e7592755c3
   Global memory size: 1 GB 935 MB 460 kB
   Local memory size: 32 kB
   Max work group size: 256
   Max work item sizes: (256, 256, 256)
…
</pre></div>
</div>
</div>
<div class="section" id="tensorflow-lite">
<h2>TensorFlow Lite<a class="headerlink" href="#tensorflow-lite" title="Permalink to this headline">¶</a></h2>
<p>RK3399 supports the neural network GPU acceleration solution LinuxNN, and Firefly Ubuntu has added LinuxNN support.</p>
<p>Under opt/tensorflowbin/, run test.sh to test the Demo of the MobileNet model image classifier and the Target Detection Demo of the MobileNet-SSD model</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>firefly@firefly:/opt/tensorflowbin$ ./test.sh
Loaded model mobilenet_ssd.tflite
resolved reporter
nn version: 1.0.0
findAvailableDevices
filename:libarmnn-driver.so d_info:40432 d_reclen:40s
[D][ArmnnDriver]: Register Service: armnn (version: 1.0.0)!
first invoked time: 1919.17 ms
invoked
average time: 108.4 ms
validCount: 26
car @ (546, 501) (661, 586)
car @ (1, 549) (51, 618)
person @ (56, 501) (239, 854)
person @ (332, 530) (368, 627)
person @ (391, 541) (434, 652)
person @ (418, 477) (538, 767)
person @ (456, 487) (602, 764)
car @ (589, 523) (858, 687)
person @ (826, 463) (1034, 873)
bicycle @ (698, 644) (1128, 925)
write out.jpg succ!
</pre></div>
</div>
</div>
<div class="section" id="on-screen-keyboard">
<h2>On-screen keyboard<a class="headerlink" href="#on-screen-keyboard" title="Permalink to this headline">¶</a></h2>
<p>The official Ubuntu system comes with an on-screen keyboard, you can click to open it in the menu bar:
<img alt="_images/onboard.jpg" src="_images/onboard.jpg" /></p>
</div>
<div class="section" id="hdmi-in-image-capture">
<h2>HDMI_IN Image capture<a class="headerlink" href="#hdmi-in-image-capture" title="Permalink to this headline">¶</a></h2>
<p><strong>This function can only be used on AIO-3399J board</strong></p>
<ul class="simple">
<li><p>Need to solder HDMI_IN input interface</p></li>
</ul>
<p>Note for manual compilation:</p>
<ul class="simple">
<li><p>This function is turned off by default, and the following operations need to be performed in the kernel warehouse:<code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">revert</span> <span class="pre">8998afb927200ad42b27beacc22cf1e86bfca442</span></code></p></li>
<li><p>Make sure this patch exists:
<a class="reference external" href="https://gitlab.com/firefly-linux/kernel/-/commit/30e174dc173fba89c9b84a2651ad46cbc68bb0ac">firefly: AIO-3399J: enable HDMI-IN function: The HDMI-IN function is enabled, but other camera and audio functions may not be used normally.</a></p></li>
</ul>
<p><strong>Test script test_hdmiin-3399_new.sh</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

export DISPLAY=:0
export XAUTHORITY=/home/firefly/.Xauthority
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
export LD_LIBRARY_PATH=/usr/lib/gstreamer-1.0

WIDTH=1920
HEIGHT=1080
SINK=kmssink
#SINK=gtksink

echo autospawn = no &gt; /home/firefly/.config/pulse/client.conf
pkill pulseaudio
sleep 1
amixer -c 1 sset &#39;IN1 Boost&#39; 0
amixer -c 1 sset &quot;RECMIXL BST1&quot; on
amixer -c 1 sset &quot;RECMIXR BST1&quot; on
amixer -c 1 sset &#39;Mono ADC MIXR ADC1&#39; on
amixer -c 1 sset &#39;Mono ADC MIXL ADC1&#39; on

gst-launch-1.0 v4l2src device=/dev/video0 ! video/x-raw,format=NV12,width=${WIDTH},height=${HEIGHT}, framerate=30/1 ! videoconvert ! $SINK &amp; # &amp;&gt;/dev/null &amp;

GST_PID=$!

sleep 2
alsaloop -P hw:1,0 -C hw:1,0 -c 2 -t 500000 &amp;
ALSA_PID=$!

trap &#39;{ kill -9 $GST_PID; kill -9 $ALSA_PID; }&#39; EXIT INT TERM

wait
</pre></div>
</div>
</div>
<div class="section" id="sound-configuration">
<h2>Sound configuration<a class="headerlink" href="#sound-configuration" title="Permalink to this headline">¶</a></h2>
<p>Equipment generally has 2 or more audio devices. The most common ones are the audio output of headphones and HDMI. The following is an example of audio settings for users’ reference.</p>
<div class="section" id="specify-audio-device-from-the-command-line">
<h3>Specify audio device from the command line<a class="headerlink" href="#specify-audio-device-from-the-command-line" title="Permalink to this headline">¶</a></h3>
<p>The audio files that come with the system are in the <code class="docutils literal notranslate"><span class="pre">/usr/share/sound/alsa/</span></code> directory, please check the sound card device before playing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># aplay -l</span>
<span class="o">****</span> <span class="n">List</span> <span class="n">of</span> <span class="n">PLAYBACK</span> <span class="n">Hardware</span> <span class="n">Devices</span> <span class="o">****</span>
<span class="n">card</span> <span class="mi">0</span><span class="p">:</span> <span class="n">rockchiprt5640c</span> <span class="p">[</span><span class="n">rockchip</span><span class="p">,</span><span class="n">rt5640</span><span class="o">-</span><span class="n">codec</span><span class="p">],</span> <span class="n">device</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ff890000</span><span class="o">.</span><span class="n">i2s</span><span class="o">-</span><span class="n">rt5640</span><span class="o">-</span><span class="n">aif1</span> <span class="n">rt5640</span><span class="o">-</span><span class="n">aif1</span><span class="o">-</span><span class="mi">0</span> <span class="p">[]</span>
  <span class="n">Subdevices</span><span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>
  <span class="n">Subdevice</span> <span class="c1">#0: subdevice #0</span>
<span class="n">card</span> <span class="mi">1</span><span class="p">:</span> <span class="n">rkhdmidpsound</span> <span class="p">[</span><span class="n">rk</span><span class="o">-</span><span class="n">hdmi</span><span class="o">-</span><span class="n">dp</span><span class="o">-</span><span class="n">sound</span><span class="p">],</span> <span class="n">device</span> <span class="mi">0</span><span class="p">:</span> <span class="n">HDMI</span><span class="o">-</span><span class="n">DP</span> <span class="n">multicodec</span><span class="o">-</span><span class="mi">0</span> <span class="p">[]</span>
  <span class="n">Subdevices</span><span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span>
  <span class="n">Subdevice</span> <span class="c1">#0: subdevice #0</span>
</pre></div>
</div>
<p>Then specify the sound card to play audio, where device 0 of sound card card0 corresponds to the headphone port, and device 0 of card1 corresponds to HDMI. The general audio playback command is <code class="docutils literal notranslate"><span class="pre">aplay</span> <span class="pre">-Dhw:0,0</span> <span class="pre">Fornt_Center.wav</span></code>, but the audio file that comes with the system is mono, so in order to prevent playback failure, you can follow the following command to play:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#Select the headphone port to output audio files</span>
<span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">sounds</span><span class="o">/</span><span class="n">alsa</span><span class="c1"># aplay -Dplughw:0,0 Front_Center.wav</span>
<span class="n">Playing</span> <span class="n">WAVE</span><span class="s1">&#39;Front_Center.wav&#39;</span><span class="p">:</span> <span class="n">Signed</span> <span class="mi">16</span> <span class="n">bit</span> <span class="n">Little</span> <span class="n">Endian</span><span class="p">,</span> <span class="n">Rate</span> <span class="mi">48000</span> <span class="n">Hz</span><span class="p">,</span> <span class="n">Mono</span>

<span class="c1">#Select HDMI output audio file</span>
<span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">sounds</span><span class="o">/</span><span class="n">alsa</span><span class="c1"># aplay -Dplughw:1,0 Front_Center.wav</span>
<span class="n">Playing</span> <span class="n">WAVE</span><span class="s1">&#39;Front_Center.wav&#39;</span><span class="p">:</span> <span class="n">Signed</span> <span class="mi">16</span> <span class="n">bit</span> <span class="n">Little</span> <span class="n">Endian</span><span class="p">,</span> <span class="n">Rate</span> <span class="mi">48000</span> <span class="n">Hz</span><span class="p">,</span> <span class="n">Mono</span>
</pre></div>
</div>
</div>
<div class="section" id="select-audio-device-in-the-graphical-interface">
<h3>Select audio device in the graphical interface<a class="headerlink" href="#select-audio-device-in-the-graphical-interface" title="Permalink to this headline">¶</a></h3>
<p>In the graphical interface, play the prepared audio file, then click the sound icon to open the <code class="docutils literal notranslate"><span class="pre">Sound</span> <span class="pre">Setting</span></code>, and select the <code class="docutils literal notranslate"><span class="pre">Configuration</span></code>. You can see two sound card devices, for example, set to HDMI output audio, then set the HDMI sound card device to <code class="docutils literal notranslate"><span class="pre">Output</span></code>, and set the other sound card to <code class="docutils literal notranslate"><span class="pre">Off</span></code>. (If the HDMI is silent or low, you can try to increase the volume by pressing the physical button on the HDMI screen)</p>
<p><img alt="_images/sound_setting.jpg" src="_images/sound_setting.jpg" /></p>
</div>
<div class="section" id="kernel-configuration">
<h3>Kernel configuration<a class="headerlink" href="#kernel-configuration" title="Permalink to this headline">¶</a></h3>
<p>In the kernel directory, open the kernel configuration options menu:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">firefly_linux_defconfig</span>
<span class="n">make</span> <span class="n">menuconfig</span>
</pre></div>
</div>
<p>After entering the kernel configuration menu, select in turn: <code class="docutils literal notranslate"><span class="pre">Device</span> <span class="pre">Drivers</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">USB</span> <span class="pre">Support</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">USB</span> <span class="pre">Gadget</span> <span class="pre">Support</span></code>.</p>
<p>Select <code class="docutils literal notranslate"><span class="pre">USB</span> <span class="pre">functions</span> <span class="pre">configurable</span> <span class="pre">through</span> <span class="pre">configfs</span></code> in the <code class="docutils literal notranslate"><span class="pre">USB</span> <span class="pre">Gadget</span> <span class="pre">Driver</span></code> option.</p>
<p>At the same time, select <code class="docutils literal notranslate"><span class="pre">Function</span> <span class="pre">filesystem</span> <span class="pre">(FunctionFS)</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;*&gt;</span> <span class="n">USB</span> <span class="n">Gadget</span> <span class="n">Drivers</span> <span class="p">(</span><span class="n">USB</span> <span class="n">functions</span> <span class="n">configurable</span> <span class="n">through</span> <span class="n">configfs</span><span class="p">)</span> <span class="o">---&gt;</span>
        <span class="n">USB</span> <span class="n">functions</span> <span class="n">configurable</span> <span class="n">through</span> <span class="n">configfs</span>
<span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Function</span> <span class="n">filesystem</span> <span class="p">(</span><span class="n">FunctionFS</span><span class="p">)</span>
</pre></div>
</div>
<p>Then compile the kernel in the <code class="docutils literal notranslate"><span class="pre">kernel</span></code> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">rk3399</span><span class="o">-</span><span class="n">firefly</span><span class="o">.</span><span class="n">img</span> <span class="o">-</span><span class="n">j12</span>
</pre></div>
</div>
<p>After the compilation is completed, burn the kernel to the device. For the burn process, please refer to the partition image burning part in the Wiki tutorial: <a class="reference internal" href="03-upgrade_firmware.html"><span class="doc">Upgrade Firmware</span></a>.</p>
</div>
<div class="section" id="adb-connection">
<h3>ADB connection<a class="headerlink" href="#adb-connection" title="Permalink to this headline">¶</a></h3>
<p>After installing ADB, connect the device and PC with a Micro USB OTG cable. Then use the command <code class="docutils literal notranslate"><span class="pre">adb</span> <span class="pre">devices</span></code> to see if there is a device connected:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>firefly@Desktop:~$ adb devices
List of devices attached
0123456789ABCDEF device
</pre></div>
</div>
<p>From the returned information, you can see that the device has been found, indicating that the device has been successfully connected.</p>
<p>After the device is successfully connected, enter the command <code class="docutils literal notranslate"><span class="pre">adb</span> <span class="pre">shell</span></code> to enter the command line mode:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>firefly@Desktop:~$ adb shell
#
</pre></div>
</div>
<p>In this state, the current path of the command line cannot be seen, and the Tab key completion function is invalid. You need to enter a user to operate normally.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>firefly@Desktop:~$ adb shell
# su firefly
To run a command as administrator (user &quot;root&quot;), use &quot;sudo &lt;command&gt;&quot;.
See &quot;man sudo_root&quot; for details.

firefly@firefly:/$
#The command line can be used normally here
</pre></div>
</div>
<p>The user can also use the command <code class="docutils literal notranslate"><span class="pre">adb</span> <span class="pre">shell</span> <span class="pre">/bin/bash</span></code>, or enter the normal command line mode.</p>
<p>You can enter <code class="docutils literal notranslate"><span class="pre">adb</span> <span class="pre">help</span></code> to view the command line help information. Note that not all commands are available. The help information is for reference only.</p>
</div>
</div>
<div class="section" id="serial-port">
<h2>Serial port<a class="headerlink" href="#serial-port" title="Permalink to this headline">¶</a></h2>
<p>There are two types of serial ports on the device, one is a common serial port and the other is a serial port converted from SPI through a conversion chip. The converted serial port has the same function as the ordinary serial port, but it is necessary to note that their device file names are different. The following is the difference between the two:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">Ordinary</span> <span class="n">serial</span> <span class="n">port</span>
<span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># ls /dev/ttyS*</span>
<span class="n">ttyS0</span> <span class="n">ttyS1</span> <span class="n">ttyS2</span> <span class="n">ttyS3</span>

<span class="o">//</span><span class="n">SPI</span> <span class="n">to</span> <span class="n">serial</span> <span class="n">port</span>
<span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># ls /dev/ttysWK*</span>
<span class="n">ttysWK0</span> <span class="n">ttysWK1</span> <span class="n">ttysWK2</span> <span class="n">ttysWK3</span>
</pre></div>
</div>
<div class="section" id="set-the-baud-rate">
<h3>Set the baud rate<a class="headerlink" href="#set-the-baud-rate" title="Permalink to this headline">¶</a></h3>
<p>Take <code class="docutils literal notranslate"><span class="pre">ttyS4</span></code> as an example to view the serial port baud rate command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># stty -F /dev/ttyS4</span>
<span class="n">speed</span> <span class="mi">9600</span> <span class="n">baud</span><span class="p">;</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="o">-</span><span class="n">brkint</span> <span class="o">-</span><span class="n">imaxbel</span>
</pre></div>
</div>
<p>Set the baud rate command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">Set</span> <span class="n">the</span> <span class="n">baud</span> <span class="n">rate</span> <span class="n">to</span> <span class="mi">115200</span>
<span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># stty -F /dev/ttyS4 ospeed 115200 ispeed 115200 cs8</span>

<span class="o">//</span><span class="n">Check</span> <span class="n">to</span> <span class="n">confirm</span> <span class="n">whether</span> <span class="n">it</span> <span class="n">has</span> <span class="n">been</span> <span class="n">modified</span>
<span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># stty -F /dev/ttyS4</span>
<span class="n">speed</span> <span class="mi">115200</span> <span class="n">baud</span><span class="p">;</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="o">-</span><span class="n">brkint</span> <span class="o">-</span><span class="n">imaxbel</span>
<span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1">#</span>
</pre></div>
</div>
</div>
<div class="section" id="turn-off-echo">
<h3>Turn off echo<a class="headerlink" href="#turn-off-echo" title="Permalink to this headline">¶</a></h3>
<p>The echo function will affect our test results when doing the loopback test, so you need to turn off the echo in the loopback test or other special circumstances. The following is the command to turn off echo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">Close</span> <span class="n">back</span> <span class="n">to</span> <span class="n">display</span>
<span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># stty -F /dev/ttyS4 -echo -echoe -echok</span>

<span class="o">//</span><span class="n">Check</span> <span class="n">the</span> <span class="n">configuration</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">functions</span> <span class="ow">and</span> <span class="n">check</span> <span class="n">whether</span> <span class="n">it</span> <span class="n">has</span> <span class="n">been</span> <span class="n">closed</span><span class="o">.</span> <span class="s2">&quot;-&quot;</span> <span class="n">means</span> <span class="n">the</span> <span class="n">function</span> <span class="n">has</span> <span class="n">been</span> <span class="n">closed</span>
<span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># stty -F /dev/ttyS4 -a | grep echo</span>
<span class="n">isig</span> <span class="n">icanon</span> <span class="n">iexten</span> <span class="o">-</span><span class="n">echo</span> <span class="o">-</span><span class="n">echoe</span> <span class="o">-</span><span class="n">echok</span> <span class="o">-</span><span class="n">echonl</span> <span class="o">-</span><span class="n">noflsh</span> <span class="o">-</span><span class="n">xcase</span> <span class="o">-</span><span class="n">tostop</span> <span class="o">-</span><span class="n">echoprt</span>
<span class="n">echoctl</span> <span class="n">echoke</span> <span class="o">-</span><span class="n">flusho</span> <span class="o">-</span><span class="n">extproc</span>
</pre></div>
</div>
</div>
<div class="section" id="send-and-receive-raw-data">
<h3>Send and receive raw data<a class="headerlink" href="#send-and-receive-raw-data" title="Permalink to this headline">¶</a></h3>
<p>In actual applications, there may be differences between the actual data sent and the data we want to send, such as a carriage return or other special characters. Use <code class="docutils literal notranslate"><span class="pre">stty</span></code> to set the send and receive to <code class="docutils literal notranslate"><span class="pre">raw</span></code> mode to ensure that the raw data is sent and received. The following is the setting command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># stty -F /dev/ttyS4 raw</span>
</pre></div>
</div>
</div>
<div class="section" id="operating-mode">
<h3>Operating mode<a class="headerlink" href="#operating-mode" title="Permalink to this headline">¶</a></h3>
<p>The serial port has two working modes: interrupt mode and DMA mode.</p>
<div class="section" id="interrupt-mode">
<h4>Interrupt mode<a class="headerlink" href="#interrupt-mode" title="Permalink to this headline">¶</a></h4>
<p>The kernel configures the serial port as interrupt mode by default, so no modification is required. The transmission rate in interrupt mode is relatively fast, but it is easy to lose packets or make mistakes when transferring large amounts of data, so please do not use interrupt mode when the amount of data is relatively large.</p>
</div>
<div class="section" id="dma-mode">
<h4>DMA mode<a class="headerlink" href="#dma-mode" title="Permalink to this headline">¶</a></h4>
<p>DMA mode is mainly used when transferring large amounts of data. The kernel will provide a buffer space for the serial port to receive data to minimize the packet loss rate of the serial port transmission.</p>
<p><strong>Note:</strong> The default size of the buffer space limit is <code class="docutils literal notranslate"><span class="pre">8K</span></code>. If one transfer exceeds the buffer size, packets will be lost, so if you use DMA mode, the sender needs to send in packets.</p>
<p>Device tree file configuration</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">uart4</span> <span class="p">{</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;okay&quot;</span><span class="p">;</span>
<span class="o">+</span> <span class="n">dmas</span> <span class="o">=</span> <span class="o">&lt;&amp;</span><span class="n">dmac_peri</span> <span class="mi">8</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;&amp;</span><span class="n">dmac_peri</span> <span class="mi">9</span><span class="o">&gt;</span><span class="p">;</span>
<span class="o">+</span> <span class="n">dma</span><span class="o">-</span><span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;tx&quot;</span><span class="p">,</span> <span class="s2">&quot;rx&quot;</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The DMA mode cannot increase the transfer rate. On the contrary, the transfer rate will be reduced because of the need for buffering, so do not use the DMA mode if you do not need to transfer a large amount of data.</p>
</div>
</div>
<div class="section" id="flow-control">
<h3>Flow Control<a class="headerlink" href="#flow-control" title="Permalink to this headline">¶</a></h3>
<p>Whether it is interrupt mode or DMA mode, data transmission cannot be guaranteed to be foolproof, because when a large amount of data is transmitted for a long time, DDR, CPU frequency conversion or high occupancy rate may cause the upper layer to process the data in time and cause packet loss. At this time, it is necessary to use Flow control. There are two types of flow control, one is software flow control and the other is hardware flow control. Only the use of hardware flow control is introduced below.</p>
<div class="section" id="hardware-support">
<h4>Hardware Support<a class="headerlink" href="#hardware-support" title="Permalink to this headline">¶</a></h4>
<p>Hardware flow control needs hardware support, and the device’s serial port <code class="docutils literal notranslate"><span class="pre">CTX</span></code> and <code class="docutils literal notranslate"><span class="pre">RTX</span></code> pins need to be connected to the remote device.</p>
<p><strong>Note:</strong> Not all serial ports of the device support hardware flow control, please confirm from the schematic diagram whether the hardware supports</p>
</div>
<div class="section" id="device-tree-file-configuration">
<h4>Device tree file configuration<a class="headerlink" href="#device-tree-file-configuration" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">uart3</span><span class="p">:</span> <span class="n">serial</span><span class="nd">@ff1b0000</span> <span class="p">{</span>
        <span class="n">compatible</span> <span class="o">=</span> <span class="s2">&quot;rockchip,rk3399-uart&quot;</span><span class="p">,</span> <span class="s2">&quot;snps,dw-apb-uart&quot;</span><span class="p">;</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mh">0x0</span> <span class="mh">0xff1b0000</span> <span class="mh">0x0</span> <span class="mh">0x100</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="n">clocks</span> <span class="o">=</span> <span class="o">&lt;&amp;</span><span class="n">cru</span> <span class="n">SCLK_UART3</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;&amp;</span><span class="n">cru</span> <span class="n">PCLK_UART3</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="n">clock</span><span class="o">-</span><span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;baudclk&quot;</span><span class="p">,</span> <span class="s2">&quot;apb_pclk&quot;</span><span class="p">;</span>
        <span class="n">interrupts</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">GIC_SPI</span> <span class="mi">101</span> <span class="n">IRQ_TYPE_LEVEL_HIGH</span> <span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="n">reg</span><span class="o">-</span><span class="n">shift</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="n">reg</span><span class="o">-</span><span class="n">io</span><span class="o">-</span><span class="n">width</span> <span class="o">=</span> <span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="n">pinctrl</span><span class="o">-</span><span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span><span class="p">;</span>
<span class="o">+</span> <span class="n">pinctrl</span><span class="o">-</span><span class="mi">0</span> <span class="o">=</span> <span class="o">&lt;&amp;</span><span class="n">uart3_xfer</span> <span class="o">&amp;</span><span class="n">uart3_cts</span> <span class="o">&amp;</span><span class="n">uart3_rts</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;disabled&quot;</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="application-layer-settings">
<h4>Application layer settings<a class="headerlink" href="#application-layer-settings" title="Permalink to this headline">¶</a></h4>
<p>The upper layer also needs to open the flow control setting. Here is how to open the flow control in stty. If you are using other applications, please turn on the flow control from the application.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">Turn</span> <span class="n">on</span> <span class="n">flow</span> <span class="n">control</span>
<span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># stty -F /dev/ttyS4 crtscts</span>

<span class="o">//</span><span class="n">Check</span> <span class="n">whether</span> <span class="n">the</span> <span class="n">flow</span> <span class="n">control</span> <span class="ow">is</span> <span class="n">turned</span> <span class="n">on</span><span class="p">,</span> <span class="n">the</span> <span class="s2">&quot;-&quot;</span> <span class="n">sign</span> <span class="n">means</span> <span class="n">that</span> <span class="n">the</span> <span class="n">function</span> <span class="n">has</span> <span class="n">been</span> <span class="n">turned</span> <span class="n">off</span>
<span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># stty -F /dev/ttyS4 -a | grep crtscts</span>
<span class="o">-</span><span class="n">parenb</span> <span class="o">-</span><span class="n">parodd</span> <span class="o">-</span><span class="n">cmspar</span> <span class="n">cs8</span> <span class="n">hupcl</span> <span class="o">-</span><span class="n">cstopb</span> <span class="n">cread</span> <span class="n">clocal</span> <span class="n">crtscts</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="mipi-camera-ov13850">
<h2>MIPI camera (OV13850)<a class="headerlink" href="#mipi-camera-ov13850" title="Permalink to this headline">¶</a></h2>
<p>The RK3399 board with <code class="docutils literal notranslate"><span class="pre">MIPI</span> <span class="pre">CSI</span></code> interface has added the support of dual MIPI camera <code class="docutils literal notranslate"><span class="pre">OV13850</span></code>, and the camera example is also added in the application. The following describes the relevant configuration.</p>
<div class="section" id="id1">
<h3>Device tree file configuration<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Take <code class="docutils literal notranslate"><span class="pre">rk3399-firefly-aiojd4.dts</span></code> as an example, these are the configurations that the camera needs to open. Since the kernel has added support for dual MIPI cameras, there are two cameras configured here. If you only use one camera, you only need to open one of the cameras.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>//Power Management
&amp;vcc_mipi {
        status = &quot;okay&quot;;
};

&amp;dvdd_1v2 {
        status = &quot;okay&quot;;
};

//MIPI camera 1
&amp;ov13850 {
        status = &quot;okay&quot;;
};
&amp;rkisp1_0 {
        status = &quot;okay&quot;;
};

&amp;mipi_dphy_rx0 {
        status = &quot;okay&quot;;
};

&amp;isp0_mmu {
        status = &quot;okay&quot;;
};
//MIPI camera 2
&amp;ov13850_1 {
        status = &quot;okay&quot;;
};
&amp;rkisp1_1 {
        status = &quot;okay&quot;;
};
&amp;mipi_dphy_tx1rx1 {
        status = &quot;okay&quot;;
};

&amp;isp1_mmu ​​{
        status = &quot;okay&quot;;
};
</pre></div>
</div>
<p><strong>Note:</strong> If you are using the <code class="docutils literal notranslate"><span class="pre">core-3399</span></code> core board plus a DIY backplane, you may need to modify the corresponding GPIO attributes.</p>
</div>
<div class="section" id="debug">
<h3>Debug<a class="headerlink" href="#debug" title="Permalink to this headline">¶</a></h3>
<p>Before running the script, confirm whether the <code class="docutils literal notranslate"><span class="pre">OV13850</span></code> device is successfully registered. The following is the successful kernel log:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># dmesg | grep ov13850</span>
<span class="o">//</span><span class="n">MIPI</span> <span class="n">camera</span> <span class="mi">1</span>
<span class="p">[</span><span class="mf">1.276762</span><span class="p">]</span> <span class="n">ov13850</span> <span class="mi">1</span><span class="o">-</span><span class="mi">0036</span><span class="p">:</span> <span class="n">GPIO</span> <span class="n">lookup</span> <span class="k">for</span> <span class="n">consumer</span> <span class="n">reset</span>
<span class="p">[</span><span class="mf">1.276771</span><span class="p">]</span> <span class="n">ov13850</span> <span class="mi">1</span><span class="o">-</span><span class="mi">0036</span><span class="p">:</span> <span class="n">using</span> <span class="n">device</span> <span class="n">tree</span> <span class="k">for</span> <span class="n">GPIO</span> <span class="n">lookup</span>
<span class="p">[</span><span class="mf">1.276803</span><span class="p">]</span> <span class="n">of_get_named_gpiod_flags</span><span class="p">:</span> <span class="n">parsed</span><span class="s1">&#39;reset-gpios&#39;</span> <span class="nb">property</span> <span class="n">of</span> <span class="n">node</span><span class="s1">&#39;/i2c@ff110000/ov13850@36[0]&#39;</span><span class="o">-</span><span class="n">status</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">[</span><span class="mf">1.276855</span><span class="p">]</span> <span class="n">ov13850</span> <span class="mi">1</span><span class="o">-</span><span class="mi">0036</span><span class="p">:</span> <span class="n">Looking</span> <span class="n">up</span> <span class="n">avdd</span><span class="o">-</span><span class="n">supply</span> <span class="kn">from</span> <span class="nn">device</span> <span class="n">tree</span>
<span class="p">[</span><span class="mf">1.277034</span><span class="p">]</span> <span class="n">ov13850</span> <span class="mi">1</span><span class="o">-</span><span class="mi">0036</span><span class="p">:</span> <span class="n">Looking</span> <span class="n">up</span> <span class="n">dovdd</span><span class="o">-</span><span class="n">supply</span> <span class="kn">from</span> <span class="nn">device</span> <span class="n">tree</span>
<span class="p">[</span><span class="mf">1.277170</span><span class="p">]</span> <span class="n">ov13850</span> <span class="mi">1</span><span class="o">-</span><span class="mi">0036</span><span class="p">:</span> <span class="n">Looking</span> <span class="n">up</span> <span class="n">dvdd</span><span class="o">-</span><span class="n">supply</span> <span class="kn">from</span> <span class="nn">device</span> <span class="n">tree</span>
<span class="p">[</span><span class="mf">1.277535</span><span class="p">]</span> <span class="n">ov13850</span> <span class="mi">1</span><span class="o">-</span><span class="mi">0036</span><span class="p">:</span> <span class="n">GPIO</span> <span class="n">lookup</span> <span class="k">for</span> <span class="n">consumer</span> <span class="n">pwdn</span>
<span class="p">[</span><span class="mf">1.277544</span><span class="p">]</span> <span class="n">ov13850</span> <span class="mi">1</span><span class="o">-</span><span class="mi">0036</span><span class="p">:</span> <span class="n">using</span> <span class="n">device</span> <span class="n">tree</span> <span class="k">for</span> <span class="n">GPIO</span> <span class="n">lookup</span>
<span class="p">[</span><span class="mf">1.277575</span><span class="p">]</span> <span class="n">of_get_named_gpiod_flags</span><span class="p">:</span> <span class="n">parsed</span><span class="s1">&#39;pwdn-gpios&#39;</span> <span class="nb">property</span> <span class="n">of</span> <span class="n">node</span><span class="s1">&#39;/i2c@ff110000/ov13850@36[0]&#39;</span><span class="o">-</span><span class="n">status</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">[</span><span class="mf">1.281862</span><span class="p">]</span> <span class="n">ov13850</span> <span class="mi">1</span><span class="o">-</span><span class="mi">0036</span><span class="p">:</span> <span class="n">Detected</span> <span class="n">OV00d850</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">REVISION</span> <span class="mh">0xb2</span>
<span class="o">//</span><span class="n">MIPI</span> <span class="n">camera</span> <span class="mi">2</span>
<span class="p">[</span><span class="mf">1.284442</span><span class="p">]</span> <span class="n">ov13850</span> <span class="mi">1</span><span class="o">-</span><span class="mi">0046</span><span class="p">:</span> <span class="n">GPIO</span> <span class="n">lookup</span> <span class="k">for</span> <span class="n">consumer</span> <span class="n">pwdn</span>
<span class="p">[</span><span class="mf">1.284461</span><span class="p">]</span> <span class="n">ov13850</span> <span class="mi">1</span><span class="o">-</span><span class="mi">0046</span><span class="p">:</span> <span class="n">using</span> <span class="n">device</span> <span class="n">tree</span> <span class="k">for</span> <span class="n">GPIO</span> <span class="n">lookup</span>
<span class="p">[</span><span class="mf">1.284523</span><span class="p">]</span> <span class="n">of_get_named_gpiod_flags</span><span class="p">:</span> <span class="n">parsed</span><span class="s1">&#39;pwdn-gpios&#39;</span> <span class="nb">property</span> <span class="n">of</span> <span class="n">node</span><span class="s1">&#39;/i2c@ff110000/ov13850@46[0]&#39;</span><span class="o">-</span><span class="n">status</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">[</span><span class="mf">1.288235</span><span class="p">]</span> <span class="n">ov13850</span> <span class="mi">1</span><span class="o">-</span><span class="mi">0046</span><span class="p">:</span> <span class="n">Detected</span> <span class="n">OV00d850</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">REVISION</span> <span class="mh">0xb2</span>
</pre></div>
</div>
<p>Related device files should be generated under <code class="docutils literal notranslate"><span class="pre">/dev</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">~</span><span class="c1"># ls /dev/video</span>
<span class="o">//</span><span class="n">MIPI</span> <span class="n">camera</span> <span class="mi">1</span>
<span class="n">video0</span> <span class="n">video1</span> <span class="n">video2</span> <span class="n">video3</span>
<span class="o">//</span><span class="n">MIPI</span> <span class="n">camera</span> <span class="mi">2</span>
<span class="n">video4</span> <span class="n">video5</span> <span class="n">video6</span> <span class="n">video7</span>
</pre></div>
</div>
<p><strong>Note:</strong> Similarly, if you only use one camera, you only need to register one camera device.</p>
</div>
<div class="section" id="test">
<h3>Test<a class="headerlink" href="#test" title="Permalink to this headline">¶</a></h3>
<p>The camera test script <code class="docutils literal notranslate"><span class="pre">/usr/local/bin/dual-camera-rkisp.sh</span></code> has been added to the official Ubuntu system, and its content is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

export DISPLAY=:0
export XAUTHORITY=/home/firefly/.Xauthority
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
export LD_LIBRARY_PATH=/usr/lib/gstreamer-1.0

WIDTH=640
HEIGHT=480
SINK=gtksink

/etc/init.d/S50set_pipeline start

# camera closed to the border of the board
gst-launch-1.0 rkisp device=/dev/video0 io-mode=1 analyzer=1 enable-3a=1 path-iqf=/etc/cam_iq.xml! video/x-raw,format=NV12,width=${ WIDTH},hei
ght=${HEIGHT}, framerate=30/1! videoconvert! $SINK &amp;

# the other camera
gst-launch-1.0 rkisp device=/dev/video4 io-mode=1 analyzer=1 enable-3a=1 path-iqf=/etc/cam_iq.xml! video/x-raw,format=NV12,width=${ WIDTH},hei
ght=${HEIGHT}, framerate=30/1! videoconvert! $SINK &amp;

wait
</pre></div>
</div>
<p>Just run the script, and the result is as shown in the figure:</p>
<p><img alt="_images/mipi_csi.jpg" src="_images/mipi_csi.jpg" /></p>
</div>
</div>
<div class="section" id="external-storage-device-rootfs">
<h2>External storage device rootfs<a class="headerlink" href="#external-storage-device-rootfs" title="Permalink to this headline">¶</a></h2>
<p>In addition to the root file system used in the internal eMMC, you can also use the root file system of external storage devices, such as SD cards, U disks, etc. The following takes SD card as an example to realize the root file system of mounting external storage device on Firefly-RK3399 device.</p>
<div class="section" id="create-a-partition-on-the-sd-card">
<h3>Create a partition on the SD card<a class="headerlink" href="#create-a-partition-on-the-sd-card" title="Permalink to this headline">¶</a></h3>
<p>Insert an SD card into the PC, and use the <code class="docutils literal notranslate"><span class="pre">gdisk</span></code> tool to separate a partition for mounting the root file system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#Users, please use `fdisk -l` to query what the SD card device name is, and use the gdisk command to enter the corresponding device
sudo gdisk /dev/sdb

GPT fdisk (gdisk) version 1.0.3

Partition table scan:
  MBR: protective
  BSD: not present
  APM: not present
  GPT: present

Found valid GPT with protective MBR; using GPT.

Command (? for help):

-------------------------------------------------- -----------------

#Enter? View help information
# Press p to display that the SD card currently has partitions. Since the used SD card has not yet created partitions, no partition information can be found

Command (? for help): p
Disk /dev/sdb: 15278080 sectors, 7.3 GiB
Model: CARD-READER
Sector size (logical/physical): 512/512 bytes
Disk identifier (GUID): 5801AE61-92ED-42FB-A144-E522E8E15827
Partition table holds up to 128 entries
Main partition table begins at sector 2 and ends at sector 33
First usable sector is 34, last usable sector is 15278046
Partitions will be aligned on 2048-sector boundaries
Total free space is 15278013 sectors (7.3 GiB)

Number Start (sector) End (sector) Size Code Name

-------------------------------------------------- -----------------

#Create a new partition, please create a suitable partition size for the root file system according to your actual situation

Command (? for help): n #Enter n to create a new partition
Partition number (1-128, default 1): 1 #Enter 1 to create the first partition
First sector (34-15278046, default = 2048) or {+-}size{KMGTP}: #Press enter directly, use the default value
Last sector (2048-15278046, default = 15278046) or {+-}size{KMGTP}: +3G #Create partition size of 3G
Current type is&#39;Linux filesystem&#39;
Hex code or GUID (L to show codes, Enter = 8300): #Press Enter to use the default value
Changed type of partition to&#39;Linux filesystem&#39;

-------------------------------------------------- -----------------

#After creation, enter i to view the unique GUID of the partition

Command (? for help): i
Using 1
Partition GUID code: 0FC63DAF-8483-4772-8E79-3D69D8477DE4 (Linux filesystem)
Partition unique GUID: 6278AF5D-BC6B-4213-BBF6-47D333B5CB53 #Use the unique GUID of the partition, just write down the first 12 digits
First sector: 2048 (at 1024.0 KiB)
Last sector: 6293503 (at 3.0 GiB)
Partition size: 6291456 sectors (3.0 GiB)
Attribute flags: 0000000000000000
Partition name:&#39;Linux filesystem&#39;

-------------------------------------------------- -----------------

#Enter wq to save changes and exit

Command (? for help): wq

Final checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING
PARTITIONS!!

Do you want to proceed? (Y/N): y
OK; writing new GUID partition table (GPT) to /dev/sdb.
Warning: The kernel is still using the old partition table.
The new table will be used at the next reboot or after you
run partprobe(8) or kpartx(8)
The operation has completed successfully.
</pre></div>
</div>
<p>Format the newly created partition.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Note sdb1 represents the device name of the partition corresponding to the SD card, please fill in according to the actual situation</span>
<span class="n">sudo</span> <span class="n">mkfs</span><span class="o">.</span><span class="n">ext4</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdb1</span>
</pre></div>
</div>
<p>After formatting is complete, use the <code class="docutils literal notranslate"><span class="pre">dd</span></code> command to burn the created root file system to the newly created partition of the SD card. (For the production of the root file system, please refer to <a class="reference internal" href="linux_build_ubuntu_rootfs.html"><span class="doc">The production of Ubuntu root file system</span></a>)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># User please fill in the path of the root file system mirror and the device name of the corresponding partition of the SD card according to the actual situation</span>
<span class="n">dd</span> <span class="n">conv</span><span class="o">=</span><span class="n">fsync</span><span class="p">,</span><span class="n">notrunc</span> <span class="k">if</span><span class="o">=/</span><span class="n">rootfs_path</span><span class="o">/</span><span class="n">rootfs</span><span class="o">.</span><span class="n">img</span> <span class="n">of</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdb1</span>
</pre></div>
</div>
</div>
<div class="section" id="mount-sd-card-root-file-system">
<h3>Mount SD card root file system<a class="headerlink" href="#mount-sd-card-root-file-system" title="Permalink to this headline">¶</a></h3>
<p>First, modify the device tree file, open the corresponding dts file, and rewrite the <code class="docutils literal notranslate"><span class="pre">root</span></code> value of the <code class="docutils literal notranslate"><span class="pre">bootargs</span></code> parameter under the <code class="docutils literal notranslate"><span class="pre">chosen</span></code> node under the root node to the unique GUID of the SD card partition written in the root file system:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#Change the value of root to the first 12 digits of the unique GUID value obtained</span>
<span class="n">chosen</span> <span class="p">{</span>
    <span class="n">bootargs</span> <span class="o">=</span> <span class="s2">&quot;earlycon=uart8250,mmio32,0xff1a0000 swiotlb=1 console=ttyFIQ0 rw root=PARTUUID=6278AF5D-BC6B rootfstype=ext4 rootwait&quot;</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Compile and burn to the device after modification.</p>
<p>After the root file system of the SD card has been burned, insert it into the TF card slot of the device and boot into the root file system of the SD card.</p>
<p>Precautions:</p>
<ul class="simple">
<li><p>Please pay attention to back up important files in the U disk or SD card before operation to avoid loss;</p></li>
<li><p>Please confirm the device name corresponding to your SD card during operation;</p></li>
<li><p>The value of the <code class="docutils literal notranslate"><span class="pre">root</span></code> parameter in the dts file uses unique GUID, just write down the first 12 digits. The user can also modify this value according to the help information of <code class="docutils literal notranslate"><span class="pre">gdisk</span></code>.</p></li>
</ul>
</div>
</div>
<div class="section" id="network-start">
<h2>Network start<a class="headerlink" href="#network-start" title="Permalink to this headline">¶</a></h2>
<p>Network booting is to use TFTP to download the kernel and dtb files from the server to the memory of the target machine. At the same time, you can use NFS to mount the network root file system to the target machine to achieve diskless booting of the target machine. The following is an example based on Firefly-RK3399 for user reference.</p>
<p>Ready to work:</p>
<ul class="simple">
<li><p>Firefly-RK3399 device;</p></li>
<li><p>Router, network cable;</p></li>
<li><p>Server with NFS and TFTP installed;</p></li>
<li><p>A created root file system.</p></li>
</ul>
<p>Note: In the example, the Ubuntu system PC is used as the server, and the connection with the device is realized through a router and a network cable. Users can make adjustments according to their actual conditions, but if the PC is directly connected to the device, please use a crossover cable. Please make sure that the server and the target machine are in the same LAN.</p>
<div class="section" id="server-deployment">
<h3>Server deployment<a class="headerlink" href="#server-deployment" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Deploy TFTP service on the server:</p></li>
</ol>
<p>Install TFTP service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">tftpd</span><span class="o">-</span><span class="n">hpa</span>
</pre></div>
</div>
<p>Create the <code class="docutils literal notranslate"><span class="pre">/tftpboot</span></code> directory and grant permissions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">tftpboot</span>
<span class="n">sudo</span> <span class="n">chmod</span> <span class="mi">777</span> <span class="o">/</span><span class="n">tftpboot</span>
</pre></div>
</div>
<p>Then modify the configuration file <code class="docutils literal notranslate"><span class="pre">/etc/default/tftpd-hpa</span></code> of the TFTP server, and modify the content as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/default/tftpd-hpa</span>

<span class="n">TFTP_USERNAME</span><span class="o">=</span><span class="s2">&quot;tftp&quot;</span>
<span class="n">TFTP_DIRECTORY</span><span class="o">=</span><span class="s2">&quot;/tftpboot&quot;</span> <span class="c1">#This is set according to the user&#39;s actual tftp directory</span>
<span class="n">TFTP_ADDRESS</span><span class="o">=</span><span class="s2">&quot;0.0.0.0:69&quot;</span>
<span class="n">TDTP_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-c -s -l&quot;</span>
</pre></div>
</div>
<p>Restart the TFTP server after exiting the modification:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">tftpd</span><span class="o">-</span><span class="n">hpa</span> <span class="n">restart</span>
</pre></div>
</div>
<p>Create a file in the <code class="docutils literal notranslate"><span class="pre">/tftpboot</span></code> directory to test whether the TFTP service is available:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>firefly@Desktop:~$ cd /tftpboot/
firefly@Desktop:/tftpboot$ touch test
firefly@Desktop:/tftpboot$ cd /tmp
firefly@Desktop:/tmp$ tftp 127.0.0.1
tftp&gt; get test
tftp&gt; q
</pre></div>
</div>
<p>Check the files in the <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> directory. If you see the <code class="docutils literal notranslate"><span class="pre">test</span></code> file, it means the TFTP server is available.</p>
<ol class="simple">
<li><p>Deploy the NFS service on the server:</p></li>
</ol>
<p>Install the NFS server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">nfs</span><span class="o">-</span><span class="n">kernel</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
<p>Create a shared directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">/</span><span class="n">nfs</span>
<span class="n">sudo</span> <span class="n">chmod</span> <span class="mi">777</span> <span class="o">/</span><span class="n">nfs</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">nfs</span>
<span class="n">sudo</span> <span class="n">mkdir</span> <span class="n">rootfs</span>
<span class="n">sudo</span> <span class="n">chmod</span> <span class="mi">777</span> <span class="n">rootfs</span>
</pre></div>
</div>
<p>Then copy the created root file system to the <code class="docutils literal notranslate"><span class="pre">/nfs/rootfs</span></code> directory. (The production of root file system can refer to: <a class="reference internal" href="linux_build_ubuntu_rootfs.html"><span class="doc">The production of Ubuntu root file system</span></a>)</p>
<p>Then configure NFS and add the location of the shared directory in <code class="docutils literal notranslate"><span class="pre">/etc/exports</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">rootfs</span> <span class="o">*</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span><span class="n">sync</span><span class="p">,</span><span class="n">no_root_squash</span><span class="p">,</span><span class="n">no_subtree_check</span><span class="p">)</span>
</pre></div>
</div>
<p>The shared directory is set according to the actual situation of the user, and the “*” represents that all users can access.</p>
<p>Restart the NFS server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">nfs</span><span class="o">-</span><span class="n">kernel</span><span class="o">-</span><span class="n">server</span> <span class="n">restart</span>
</pre></div>
</div>
<p>Mount the shared directory locally to test whether the NFS server is available:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mount</span> <span class="o">-</span><span class="n">t</span> <span class="n">nfs</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">rootfs</span><span class="o">/</span> <span class="o">/</span><span class="n">mnt</span>
</pre></div>
</div>
<p>If the contents consistent with <code class="docutils literal notranslate"><span class="pre">/nfs/rootfs</span></code> are viewed in the <code class="docutils literal notranslate"><span class="pre">/mnt</span></code> directory, it indicates that the NFS server is deployed successfully. Then you can unmount:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">umount</span> <span class="o">/</span><span class="n">mnt</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>Kernel configuration<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>If you want to mount the network root file system, you need to configure the kernel and modify the configuration of the root file system in dts.</p>
<p>First perform the kernel configuration, execute <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">menuconfig</span></code> in the kernel directory, and select the relevant configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Networking</span> <span class="n">support</span> <span class="o">---&gt;</span>
         <span class="n">Networking</span> <span class="n">options</span> <span class="o">---&gt;</span>
                <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">IP</span><span class="p">:</span> <span class="n">kernel</span> <span class="n">level</span> <span class="n">autoconfiguration</span>
                <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">IP</span><span class="p">:</span> <span class="n">DHCP</span> <span class="n">support</span>
                <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">IP</span><span class="p">:</span> <span class="n">BOOTP</span> <span class="n">support</span>
                <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">IP</span><span class="p">:</span> <span class="n">RARP</span> <span class="n">support</span>

<span class="n">File</span> <span class="n">systems</span> <span class="o">---&gt;</span>
        <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Network</span> <span class="n">File</span> <span class="n">Systems</span> <span class="o">---&gt;</span>
                <span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">Root</span> <span class="n">file</span> <span class="n">system</span> <span class="n">on</span> <span class="n">NFS</span>
</pre></div>
</div>
<p>Modify the <code class="docutils literal notranslate"><span class="pre">rk3399-firefly.dts</span></code> configuration, modify the <code class="docutils literal notranslate"><span class="pre">bootargs</span></code> parameter under the <code class="docutils literal notranslate"><span class="pre">chosen</span></code> node in the dts file, and choose to use NFS to mount the remote root file system. The content is as follows.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chosen</span> <span class="p">{</span>
    <span class="n">bootargs</span> <span class="o">=</span> <span class="s2">&quot;earlycon=uart8250,mmio32,0xff1a0000 swiotlb=1 console=ttyFIQ0 root=/dev/nfs rootfstype=ext4 rootwait&quot;</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">#Mainly to modify the value of root, root=/dev/nfs means to mount the network root file system through NFS</span>
</pre></div>
</div>
<p>Compile the kernel:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">ARCH</span><span class="o">=</span><span class="n">arm64</span> <span class="n">rk3399</span><span class="o">-</span><span class="n">firefly</span><span class="o">.</span><span class="n">img</span> <span class="o">-</span><span class="n">j12</span>
</pre></div>
</div>
<p>After the compilation is complete, copy the compiled kernel files <code class="docutils literal notranslate"><span class="pre">boot.img</span></code> and <code class="docutils literal notranslate"><span class="pre">rk3399-firefly.dtb</span></code> files to the <code class="docutils literal notranslate"><span class="pre">/tftpboot</span></code> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="n">boot</span><span class="o">.</span><span class="n">img</span> <span class="o">/</span><span class="n">tftpboot</span>
<span class="n">cp</span> <span class="n">arch</span><span class="o">/</span><span class="n">arm64</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">dts</span><span class="o">/</span><span class="n">rockchip</span><span class="o">/</span><span class="n">rk3399</span><span class="o">-</span><span class="n">firefly</span><span class="o">.</span><span class="n">dtb</span> <span class="o">/</span><span class="n">tftpboot</span>
</pre></div>
</div>
<p>For detailed instructions, please refer to <code class="docutils literal notranslate"><span class="pre">kernel/Documentation/filesystems/nfs/nfsroot.txt</span></code> in the kernel directory</p>
</div>
<div class="section" id="u-boot-settings">
<h3>U-Boot Settings<a class="headerlink" href="#u-boot-settings" title="Permalink to this headline">¶</a></h3>
<p>Please make sure that the network cable of the target machine is plugged in and connected to the LAN of the server.</p>
<p>The target machine boots into U-Boot command line mode, and set the following parameters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">=&gt;</span> <span class="n">setenv</span> <span class="n">ipaddr</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">31.101</span> <span class="c1">#Set the IP address of the target machine</span>
<span class="o">=&gt;</span> <span class="n">setenv</span> <span class="n">serverip</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">31.106</span> <span class="c1">#Set serverip as the server IP address</span>

<span class="c1">#Set to download the kernel and dtb file from TFTP to the corresponding address, users should modify the corresponding address according to their actual target machine</span>
<span class="o">=&gt;</span> <span class="n">setenv</span> <span class="n">bootcmd</span> <span class="n">tftpboot</span> <span class="mh">0x0027f800</span> <span class="n">boot</span><span class="o">.</span><span class="n">img</span> \<span class="p">;</span> <span class="n">tftpboot</span> <span class="mh">0x08300000</span> <span class="n">rk3399</span><span class="o">-</span><span class="n">firefly</span><span class="o">.</span><span class="n">dtb</span> \<span class="p">;</span> <span class="n">bootm</span> <span class="mh">0x0027f800</span><span class="o">-</span><span class="mh">0x08300000</span>

<span class="c1">#Set and mount the network root file system, the IP parameters are in order: target machine IP: server IP: gateway: netmask: device name: off, you can set ip=dhcp more simply, and automatically assign IP through DHXP</span>
<span class="o">=&gt;</span> <span class="n">setenv</span> <span class="n">bootargs</span> <span class="n">root</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">nfs</span> <span class="n">rw</span> <span class="n">nfsroot</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">31.106</span><span class="p">:</span><span class="o">/</span><span class="n">nfs</span><span class="o">/</span><span class="n">rootfs</span><span class="p">,</span><span class="n">v3</span> <span class="n">ip</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">31.101</span><span class="p">:</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">31.106</span><span class="p">:</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">31.1</span><span class="p">:</span><span class="mf">255.255</span><span class="o">.</span><span class="mf">255.0</span><span class="p">::</span><span class="n">eth0</span><span class="p">:</span><span class="n">off</span>

<span class="c1">#If you don’t want to set it every time you boot, you can save the variables configured above</span>
<span class="o">=&gt;</span> <span class="n">saveenv</span>
<span class="n">Saving</span> <span class="n">Environment</span> <span class="n">to</span> <span class="n">MMC</span><span class="o">...</span>
<span class="n">Writing</span> <span class="n">to</span> <span class="n">MMC</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">...</span> <span class="n">done</span>

<span class="c1">#Start the target machine</span>
<span class="o">=&gt;</span> <span class="n">boot</span>
<span class="n">ethernet</span><span class="nd">@fe300000</span> <span class="n">Waiting</span> <span class="k">for</span> <span class="n">PHY</span> <span class="n">auto</span> <span class="n">negotiation</span> <span class="n">to</span> <span class="n">complete</span><span class="o">.</span> <span class="n">done</span>
<span class="n">Speed</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="n">full</span> <span class="n">duplex</span>
<span class="n">Using</span> <span class="n">ethernet</span><span class="nd">@fe300000</span> <span class="n">device</span>
<span class="n">TFTP</span> <span class="kn">from</span> <span class="nn">server</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">31.106</span><span class="p">;</span> <span class="n">our</span> <span class="n">IP</span> <span class="n">address</span> <span class="ow">is</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">31.101</span>
<span class="n">Filename</span><span class="s1">&#39;boot.img&#39;</span><span class="o">.</span>
<span class="n">Load</span> <span class="n">address</span><span class="p">:</span> <span class="mh">0x27f800</span>
<span class="n">Loading</span><span class="p">:</span> <span class="c1">############################################# ################</span>
         <span class="c1">############################################## ###############</span>
         <span class="c1">############################################## ###############</span>
         <span class="c1">############################################## ###############</span>
         <span class="c1">############################################## ###############</span>
         <span class="c1">##############################################</span>
         <span class="mf">475.6</span> <span class="n">KiB</span><span class="o">/</span><span class="n">s</span>
<span class="n">done</span>
<span class="n">Bytes</span> <span class="n">transferred</span> <span class="o">=</span> <span class="mi">20072448</span> <span class="p">(</span><span class="mi">1324800</span> <span class="nb">hex</span><span class="p">)</span>
<span class="n">Speed</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="n">full</span> <span class="n">duplex</span>
<span class="n">Using</span> <span class="n">ethernet</span><span class="nd">@fe300000</span> <span class="n">device</span>
<span class="n">TFTP</span> <span class="kn">from</span> <span class="nn">server</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">31.106</span><span class="p">;</span> <span class="n">our</span> <span class="n">IP</span> <span class="n">address</span> <span class="ow">is</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">31.101</span>
<span class="n">Filename</span><span class="s1">&#39;rk3399-firefly.dtb&#39;</span><span class="o">.</span>
<span class="n">Load</span> <span class="n">address</span><span class="p">:</span> <span class="mh">0x8300000</span>
<span class="n">Loading</span><span class="p">:</span> <span class="c1">#######</span>
         <span class="mf">645.5</span> <span class="n">KiB</span><span class="o">/</span><span class="n">s</span>
<span class="n">done</span>
<span class="n">Bytes</span> <span class="n">transferred</span> <span class="o">=</span> <span class="mi">97212</span> <span class="p">(</span><span class="mi">17</span><span class="n">bbc</span> <span class="nb">hex</span><span class="p">)</span>
<span class="c1">## Booting Android Image at 0x0027f800 ...</span>
<span class="n">Kernel</span> <span class="n">load</span> <span class="n">addr</span> <span class="mh">0x00280000</span> <span class="n">size</span> <span class="mi">19377</span> <span class="n">KiB</span>
<span class="c1">## Flattened Device Tree blob at 08300000</span>
   <span class="n">Booting</span> <span class="n">using</span> <span class="n">the</span> <span class="n">fdt</span> <span class="n">blob</span> <span class="n">at</span> <span class="mh">0x8300000</span>
   <span class="n">XIP</span> <span class="n">Kernel</span> <span class="n">Image</span> <span class="o">...</span> <span class="n">OK</span>
   <span class="n">Loading</span> <span class="n">Device</span> <span class="n">Tree</span> <span class="n">to</span> <span class="mi">0000000073</span><span class="n">edc000</span><span class="p">,</span> <span class="n">end</span> <span class="mi">0000000073</span><span class="n">ef6bbb</span> <span class="o">...</span> <span class="n">OK</span>
<span class="n">Adding</span> <span class="n">bank</span><span class="p">:</span> <span class="mh">0x00200000</span><span class="o">-</span><span class="mh">0x08400000</span> <span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="mh">0x08200000</span><span class="p">)</span>
<span class="n">Adding</span> <span class="n">bank</span><span class="p">:</span> <span class="mh">0x0a200000</span><span class="o">-</span><span class="mh">0x80000000</span> <span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="mh">0x75e00000</span><span class="p">)</span>
<span class="n">Total</span><span class="p">:</span> <span class="mf">912260.463</span> <span class="n">ms</span>

<span class="n">Starting</span> <span class="n">kernel</span> <span class="o">...</span>

<span class="o">...</span>
</pre></div>
</div>
<p>Visible in the boot kernel log:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mf">12.146297</span><span class="p">]</span> <span class="n">VFS</span><span class="p">:</span> <span class="n">Mounted</span> <span class="n">root</span> <span class="p">(</span><span class="n">nfs</span> <span class="n">filesystem</span><span class="p">)</span> <span class="n">on</span> <span class="n">device</span> <span class="mi">0</span><span class="p">:</span><span class="mf">16.</span>
</pre></div>
</div>
<p>It indicates that the network root file system has been mounted.</p>
<p>Precautions</p>
<ul class="simple">
<li><p>Ensure that the TFTP server and NFS server are available;</p></li>
<li><p>Make sure that the target machine is plugged into the network cable first and then turned on, and is in the same LAN as the server. If it is directly connected to the target machine and the server, please use a crossover network cable;</p></li>
<li><p>In the kernel configuration, <code class="docutils literal notranslate"><span class="pre">Root</span> <span class="pre">file</span> <span class="pre">system</span> <span class="pre">on</span> <span class="pre">NFS</span></code> depends on the <code class="docutils literal notranslate"><span class="pre">IP:</span> <span class="pre">kernel</span> <span class="pre">level</span> <span class="pre">autoconfiguration</span></code> option, please select <code class="docutils literal notranslate"><span class="pre">IP:</span> <span class="pre">kernel</span> <span class="pre">level</span> <span class="pre">autoconfiguration</span></code> first, and then you can find the <code class="docutils literal notranslate"><span class="pre">Root</span> <span class="pre">file</span> <span class="pre">system</span> <span class="pre">on</span> <span class="pre">NFS</span></code> option;</p></li>
<li><p>In the U-Boot command line, please confirm the burning address of <code class="docutils literal notranslate"><span class="pre">boot.img</span></code> and the burning address of dtb file. (Hint: In the file structure of <code class="docutils literal notranslate"><span class="pre">boot.img</span></code>, there is a 2k header file at the beginning, and then the kernel. So when TFTP downloads the kernel to the target machine, it must be downloaded to the corresponding kernel address minus 0x0800);</p></li>
<li><p>When setting to mount the remote root file system, <code class="docutils literal notranslate"><span class="pre">v3</span></code> in <code class="docutils literal notranslate"><span class="pre">nfsroot=192.168.31.106:/nfs/rootfs,v3</span></code> represents the NFS version information, please add it to avoid the problem of unsuccessful mounting.</p></li>
</ul>
</div>
</div>
<div class="section" id="update-kernel-and-u-boot-online">
<h2>Update kernel and U-Boot online<a class="headerlink" href="#update-kernel-and-u-boot-online" title="Permalink to this headline">¶</a></h2>
<p>This section introduces a simple process of online update. Pack the kernel, U-Boot or other files that need to be updated into a deb installation package, and then import it to the local package warehouse to download and update automatically on the device. For user reference only.</p>
<div class="section" id="prepare-deb-installation-package">
<h3>Prepare deb installation package<a class="headerlink" href="#prepare-deb-installation-package" title="Permalink to this headline">¶</a></h3>
<p>The kernel and U-Boot need to be upgraded during the operation, and the modified related files have been prepared in advance: <code class="docutils literal notranslate"><span class="pre">uboot.img</span></code>, <code class="docutils literal notranslate"><span class="pre">trust.img</span></code>, <code class="docutils literal notranslate"><span class="pre">boot.img</span></code>.</p>
<p>deb is the package format of Debian Linux. The most important thing for packaging is to create a <code class="docutils literal notranslate"><span class="pre">control</span></code> file in the <code class="docutils literal notranslate"><span class="pre">DEBIAN</span></code> directory. First create the deb working directory, and then create the corresponding directories and files in the deb directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="n">deb</span>
<span class="n">cd</span> <span class="n">deb</span>
<span class="n">mkdir</span> <span class="n">firefly</span><span class="o">-</span><span class="n">firmware</span> <span class="c1">#Create firefly-firmware directory</span>
<span class="n">cd</span> <span class="n">firefly</span><span class="o">-</span><span class="n">firmware</span>
<span class="n">mkdir</span> <span class="n">DEBIAN</span> <span class="c1">#Create a DEBIAN directory, this directory is required.</span>
<span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="p">{</span><span class="n">kernel</span><span class="p">,</span><span class="n">uboot</span><span class="p">}</span>
<span class="n">mv</span> <span class="o">~/</span><span class="n">boot</span><span class="o">.</span><span class="n">img</span> <span class="o">~/</span><span class="n">deb</span><span class="o">/</span><span class="n">firefly</span><span class="o">-</span><span class="n">firmware</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">kernel</span> <span class="c1">#Place the corresponding file in the corresponding directory</span>
<span class="n">mv</span> <span class="o">~/</span><span class="n">uboot</span><span class="o">.</span><span class="n">img</span> <span class="o">~/</span><span class="n">deb</span><span class="o">/</span><span class="n">firefly</span><span class="o">-</span><span class="n">firmware</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">uboot</span>
<span class="n">mv</span> <span class="o">~/</span><span class="n">trust</span><span class="o">.</span><span class="n">img</span> <span class="o">~/</span><span class="n">deb</span><span class="o">/</span><span class="n">firefly</span><span class="o">-</span><span class="n">firmware</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">uboot</span>
</pre></div>
</div>
<p>The files stored in the <code class="docutils literal notranslate"><span class="pre">DEBIAN</span></code> directory are the control files for the deb package installation and the corresponding script files.</p>
<p>Create the control file <code class="docutils literal notranslate"><span class="pre">control</span></code> and the script file <code class="docutils literal notranslate"><span class="pre">postinst</span></code> in the <code class="docutils literal notranslate"><span class="pre">DEBIAN</span></code> directory.</p>
<p>The content of the <code class="docutils literal notranslate"><span class="pre">control</span></code> file is as follows, which is used to record software identification, version number, platform, dependency information and other data.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Package</span><span class="p">:</span> <span class="n">firefly</span><span class="o">-</span><span class="n">firmware</span> <span class="c1">#File directory name</span>
<span class="n">Version</span><span class="p">:</span> <span class="mf">1.0</span> <span class="c1">#Version number</span>
<span class="n">Architecture</span><span class="p">:</span> <span class="n">arm64</span> <span class="c1">#Architecture</span>
<span class="n">Maintainer</span><span class="p">:</span> <span class="n">neg</span> <span class="c1">#Maintainer, you can customize</span>
<span class="n">Installed</span><span class="o">-</span><span class="n">Size</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Section</span><span class="p">:</span> <span class="n">test</span>
<span class="n">Priority</span><span class="p">:</span> <span class="n">optional</span>
<span class="n">Descriptionon</span><span class="p">:</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">deb</span> <span class="n">test</span>
</pre></div>
</div>
<p>The content of the <code class="docutils literal notranslate"><span class="pre">postinst</span></code> file is as follows, which is to write the kernel and U-Boot files that need to be updated into the script of the corresponding partition with the <code class="docutils literal notranslate"><span class="pre">dd</span></code> command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s2">&quot;-----------uboot updating------------&quot;</span>
<span class="n">dd</span> <span class="n">conv</span><span class="o">=</span><span class="n">fsync</span><span class="p">,</span><span class="n">notrunc</span> <span class="k">if</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">uboot</span><span class="o">/</span><span class="n">uboot</span><span class="o">.</span><span class="n">img</span> <span class="n">of</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="n">partlabel</span><span class="o">/</span><span class="n">uboot</span>

<span class="n">echo</span> <span class="s2">&quot;-----------trust updating------------&quot;</span>
<span class="n">dd</span> <span class="n">conv</span><span class="o">=</span><span class="n">fsync</span><span class="p">,</span><span class="n">notrunc</span> <span class="k">if</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">uboot</span><span class="o">/</span><span class="n">trust</span><span class="o">.</span><span class="n">img</span> <span class="n">of</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="n">partlabel</span><span class="o">/</span><span class="n">trust</span>

<span class="n">echo</span> <span class="s2">&quot;-----------kernel updating------------&quot;</span>
<span class="n">dd</span> <span class="n">conv</span><span class="o">=</span><span class="n">fsync</span><span class="p">,</span><span class="n">notrunc</span> <span class="k">if</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">kernel</span><span class="o">/</span><span class="n">boot</span><span class="o">.</span><span class="n">img</span> <span class="n">of</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="n">partlabel</span><span class="o">/</span><span class="n">boot</span>
</pre></div>
</div>
<p>Description: The <code class="docutils literal notranslate"><span class="pre">postinst</span></code> script is a script that runs after unpacking the data, and the corresponding ones are:</p>
<ul class="simple">
<li><p>preinst: a script that runs before unpacking the data;</p></li>
<li><p>prerm: When uninstalling, the script that runs before deleting files;</p></li>
<li><p>postrm: a script to run after deleting the file;</p></li>
</ul>
<p>Users can understand other related knowledge points by themselves. Only the <code class="docutils literal notranslate"><span class="pre">preinst</span></code> script is used here.</p>
<p>The following is the created directory tree:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>deb
└── firefly-firmware
    ├── DEBIAN
    │ ├── control
    │ └── postinst
    └── usr
        └── share
            ├── kernel
            │ └── boot.img
            └── uboot
                ├── trust.img
                └── uboot.img
</pre></div>
</div>
<p>Enter the deb directory and use the <code class="docutils literal notranslate"><span class="pre">dpkg</span></code> command to generate the deb package:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dpkg</span> <span class="o">-</span><span class="n">b</span> <span class="n">firefly</span><span class="o">-</span><span class="n">firmware</span> <span class="n">firefly</span><span class="o">-</span><span class="n">firmware_1</span><span class="o">.</span><span class="mi">0</span><span class="n">_arm64</span><span class="o">.</span><span class="n">deb</span>
</pre></div>
</div>
<p>When generating a deb package, it is generally named according to this specification: <code class="docutils literal notranslate"><span class="pre">package_version-reversion_arch.deb</span></code>.</p>
</div>
<div class="section" id="create-a-local-warehouse">
<h3>Create a local warehouse<a class="headerlink" href="#create-a-local-warehouse" title="Permalink to this headline">¶</a></h3>
<p>First install the required packages:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">reprepro</span> <span class="n">gnupg</span>
</pre></div>
</div>
<p>Then use the GnuPG tool to generate a GPG key. After executing the command, follow the prompts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gpg</span> <span class="o">--</span><span class="n">gen</span><span class="o">-</span><span class="n">key</span>
</pre></div>
</div>
<p>Execute <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">gpg</span> <span class="pre">--list-keys</span></code> to view the key information just generated:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">gpg</span> <span class="o">--</span><span class="nb">list</span><span class="o">-</span><span class="n">keys</span>

<span class="n">gpg</span><span class="p">:</span> <span class="n">WARNING</span><span class="p">:</span> <span class="n">unsafe</span> <span class="n">ownership</span> <span class="n">on</span> <span class="n">homedir</span><span class="s1">&#39;/home/firefly/.gnupg&#39;</span>
<span class="n">gpg</span><span class="p">:</span> <span class="n">checking</span> <span class="n">trust</span> <span class="n">database</span>
<span class="n">gpg</span><span class="p">:</span> <span class="n">marginals</span> <span class="n">needed</span><span class="p">:</span> <span class="mi">3</span> <span class="n">completes</span> <span class="n">needed</span><span class="p">:</span> <span class="mi">1</span> <span class="n">trust</span> <span class="n">model</span><span class="p">:</span> <span class="n">pgp</span>
<span class="n">gpg</span><span class="p">:</span> <span class="n">Depth</span><span class="p">:</span> <span class="mi">0</span> <span class="n">Validity</span><span class="p">:</span> <span class="mi">4</span> <span class="n">Signed</span><span class="p">:</span> <span class="mi">0</span> <span class="n">Trust</span><span class="p">:</span> <span class="mi">0</span><span class="o">-</span><span class="p">,</span> <span class="mi">0</span><span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="n">f</span><span class="p">,</span> <span class="mi">4</span><span class="n">u</span>
<span class="n">gpg</span><span class="p">:</span> <span class="n">The</span> <span class="nb">next</span> <span class="n">trust</span> <span class="n">database</span> <span class="n">check</span> <span class="n">will</span> <span class="n">be</span> <span class="n">conducted</span> <span class="n">on</span> <span class="n">May</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">2021</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">firefly</span><span class="o">/.</span><span class="n">gnupg</span><span class="o">/</span><span class="n">pubring</span><span class="o">.</span><span class="n">kbx</span>
<span class="o">--------------------------------</span>
<span class="n">pub</span> <span class="n">rsa3072</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="p">[</span><span class="n">SC</span><span class="p">]</span> <span class="p">[</span><span class="n">Valid</span> <span class="n">until</span><span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">30</span><span class="p">]</span>
      <span class="n">BCB65788541D632C057E696B8CBC526C05417B76</span>
<span class="n">uid</span> <span class="p">[</span><span class="n">absolutely</span><span class="p">]</span> <span class="n">firefly</span> <span class="o">&lt;</span><span class="n">firefly</span><span class="nd">@t</span><span class="o">-</span><span class="n">chip</span><span class="o">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="n">sub</span> <span class="n">rsa3072</span> <span class="mi">2019</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">31</span> <span class="p">[</span><span class="n">E</span><span class="p">]</span> <span class="p">[</span><span class="n">Valid</span> <span class="n">until</span><span class="p">:</span> <span class="mi">2021</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">30</span><span class="p">]</span>
</pre></div>
</div>
<p>Next to create a package warehouse, first create a directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span>
<span class="n">mkdir</span> <span class="n">apt</span> <span class="c1">#package warehouse directory</span>
<span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">./</span><span class="n">apt</span><span class="o">/</span><span class="n">incoming</span>
<span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">./</span><span class="n">apt</span><span class="o">/</span><span class="n">conf</span>
<span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">./</span><span class="n">apt</span><span class="o">/</span><span class="n">key</span>
</pre></div>
</div>
<p>Export the previously generated key to the warehouse folder, and please correspond to the user name and email address you created.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gpg</span> <span class="o">--</span><span class="n">armor</span> <span class="o">--</span><span class="n">export</span> <span class="n">firefly</span> <span class="n">firefly</span><span class="nd">@t</span><span class="o">-</span><span class="n">chip</span><span class="o">.</span><span class="n">com</span><span class="o">&gt;</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">key</span><span class="o">/</span><span class="n">deb</span><span class="o">.</span><span class="n">gpg</span><span class="o">.</span><span class="n">key</span>
</pre></div>
</div>
<p>Create a <code class="docutils literal notranslate"><span class="pre">distributions</span></code> file in the <code class="docutils literal notranslate"><span class="pre">conf</span></code> directory with the following content:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Origin</span><span class="p">:</span> <span class="n">Neg</span> <span class="c1">#Your name</span>
<span class="n">Label</span><span class="p">:</span> <span class="n">Mian</span> <span class="c1">#The name of the library</span>
<span class="n">Suite</span><span class="p">:</span> <span class="n">stable</span> <span class="c1">#(stable or unstable)</span>
<span class="n">Codename</span><span class="p">:</span> <span class="n">bionic</span> <span class="c1">#Release code name, can be customized</span>
<span class="n">Version</span><span class="p">:</span> <span class="mf">1.0</span> <span class="c1">#release version</span>
<span class="n">Architectures</span><span class="p">:</span> <span class="n">arm64</span> <span class="c1">#Architecture</span>
<span class="n">Components</span><span class="p">:</span> <span class="n">main</span> <span class="c1">#component name, such as main, universe, etc.</span>
<span class="n">Description</span><span class="p">:</span> <span class="n">Deb</span> <span class="n">source</span> <span class="n">test</span> <span class="c1">#Related description</span>
<span class="n">SignWith</span><span class="p">:</span> <span class="n">BCB65788541D632C057E696B8CBC526C05417B76</span> <span class="c1">#The GPG key generated in the above step</span>
</pre></div>
</div>
<p>Build a warehouse tree:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reprepro</span> <span class="o">--</span><span class="n">ask</span><span class="o">-</span><span class="n">passphrase</span> <span class="o">-</span><span class="n">Vb</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">apt</span> <span class="n">export</span>
</pre></div>
</div>
<p>Add the deb package made in step 2 to the warehouse:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reprepro</span> <span class="o">--</span><span class="n">ask</span><span class="o">-</span><span class="n">passphrase</span> <span class="o">-</span><span class="n">Vb</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">apt</span> <span class="n">includedeb</span> <span class="n">bionic</span> <span class="o">~/</span><span class="n">deb</span><span class="o">/</span><span class="n">firefly</span><span class="o">-</span><span class="n">firmware_1</span><span class="o">.</span><span class="mi">0</span><span class="n">_arm64</span><span class="o">.</span><span class="n">deb</span>
</pre></div>
</div>
<p>You can view the files added in the library:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@Desktop</span><span class="p">:</span><span class="o">~</span><span class="c1"># reprepro -b /var/www/apt/ list bionic</span>
<span class="n">bionic</span><span class="o">|</span><span class="n">main</span><span class="o">|</span><span class="n">arm64</span><span class="p">:</span> <span class="n">firefly</span><span class="o">-</span><span class="n">firmware</span> <span class="mf">1.0</span>
</pre></div>
</div>
<p>Your package has been added to the repository, if you want to remove it, use the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reprepro</span> <span class="o">--</span><span class="n">ask</span><span class="o">-</span><span class="n">passphrase</span> <span class="o">-</span><span class="n">Vb</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">apt</span> <span class="n">remove</span> <span class="n">bionic</span> <span class="n">firefly</span><span class="o">-</span><span class="n">firmware</span>
</pre></div>
</div>
<p>Install nginx server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">nginx</span>
</pre></div>
</div>
<p>Modify the nginx configuration file <code class="docutils literal notranslate"><span class="pre">/etc/nginx/sites-available/default</span></code> to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">server</span> <span class="p">{</span>
    <span class="n">listen</span> <span class="mi">80</span> <span class="n">default_server</span><span class="p">;</span>
    <span class="n">listen</span> <span class="p">[::]:</span><span class="mi">80</span> <span class="n">default_server</span><span class="p">;</span>

    <span class="n">root</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">apt</span><span class="p">;</span> <span class="o">//</span><span class="n">The</span> <span class="n">path</span> <span class="n">of</span> <span class="n">the</span> <span class="n">local</span> <span class="n">package</span> <span class="n">warehouse</span>

    <span class="n">access_log</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">repo</span><span class="o">.</span><span class="n">access</span><span class="o">.</span><span class="n">log</span><span class="p">;</span>
    <span class="n">error_log</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">repo</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">log</span><span class="p">;</span>

    <span class="n">location</span> <span class="o">~</span> <span class="o">/</span><span class="p">(</span><span class="n">db</span><span class="o">|</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">deny</span> <span class="nb">all</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">404</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Restart the nginx server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">nginx</span> <span class="n">restart</span>
</pre></div>
</div>
</div>
<div class="section" id="client-update-installation">
<h3>Client update installation<a class="headerlink" href="#client-update-installation" title="Permalink to this headline">¶</a></h3>
<p>In the client device, first add the source of the local package repository, add a new configuration file <code class="docutils literal notranslate"><span class="pre">bionic.list</span></code> under the directory <code class="docutils literal notranslate"><span class="pre">/etc/apt/sources.list.d</span></code>, the content is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">deb</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">31.106</span> <span class="n">bionic</span> <span class="n">main</span>
</pre></div>
</div>
<p>The IP address is the server address, <code class="docutils literal notranslate"><span class="pre">bionic</span></code> is the warehouse release code name, and <code class="docutils literal notranslate"><span class="pre">main</span></code> is the component name.</p>
<p>Obtain and add the GPG key from the server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="o">-</span><span class="n">O</span><span class="o">-</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">31.106</span><span class="o">/</span><span class="n">key</span><span class="o">/</span><span class="n">deb</span><span class="o">.</span><span class="n">gpg</span><span class="o">.</span><span class="n">key</span> <span class="o">|</span> <span class="n">apt</span><span class="o">-</span><span class="n">key</span> <span class="n">add</span><span class="o">-</span>
</pre></div>
</div>
<p>After the update, you can install the <code class="docutils literal notranslate"><span class="pre">firefly-firmware_1.0_arm64</span></code> package in the custom software source:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">firefly</span><span class="c1"># apt-get update</span>
<span class="n">Hit</span><span class="p">:</span><span class="mi">1</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">31.106</span> <span class="n">bionic</span> <span class="n">InRelease</span>
<span class="n">Hit</span><span class="p">:</span><span class="mi">2</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">wiki</span><span class="o">.</span><span class="n">t</span><span class="o">-</span><span class="n">firefly</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">firefly</span><span class="o">-</span><span class="n">rk3399</span><span class="o">-</span><span class="n">repo</span> <span class="n">bionic</span> <span class="n">InRelease</span>
<span class="n">Hit</span><span class="p">:</span><span class="mi">3</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ports</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">ports</span> <span class="n">bionic</span> <span class="n">InRelease</span>
<span class="n">Hit</span><span class="p">:</span><span class="mi">4</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">archive</span><span class="o">.</span><span class="n">canonical</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ubuntu</span> <span class="n">bionic</span> <span class="n">InRelease</span>
<span class="n">Hit</span><span class="p">:</span><span class="mi">5</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ports</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">ports</span> <span class="n">bionic</span><span class="o">-</span><span class="n">updates</span> <span class="n">InRelease</span>
<span class="n">Hit</span><span class="p">:</span><span class="mi">6</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ports</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">ports</span> <span class="n">bionic</span><span class="o">-</span><span class="n">backports</span> <span class="n">InRelease</span>
<span class="n">Hit</span><span class="p">:</span><span class="mi">7</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ports</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">ports</span> <span class="n">bionic</span><span class="o">-</span><span class="n">security</span> <span class="n">InRelease</span>
<span class="n">Reading</span> <span class="n">package</span> <span class="n">lists</span><span class="o">...</span> <span class="n">Done</span>

<span class="n">root</span><span class="nd">@firefly</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">firefly</span><span class="c1"># apt-get install firefly-firmware</span>
<span class="n">Reading</span> <span class="n">package</span> <span class="n">lists</span><span class="o">...</span> <span class="n">Done</span>
<span class="n">Building</span> <span class="n">dependency</span> <span class="n">tree</span>
<span class="n">Reading</span> <span class="n">state</span> <span class="n">information</span><span class="o">...</span> <span class="n">Done</span>
<span class="n">The</span> <span class="n">following</span> <span class="n">package</span> <span class="n">was</span> <span class="n">automatically</span> <span class="n">installed</span> <span class="ow">and</span> <span class="ow">is</span> <span class="n">no</span> <span class="n">longer</span> <span class="n">required</span><span class="p">:</span>
  <span class="n">libllvm6</span><span class="o">.</span><span class="mi">0</span>
<span class="n">Use</span><span class="s1">&#39;apt autoremove&#39;</span> <span class="n">to</span> <span class="n">remove</span> <span class="n">it</span><span class="o">.</span>
<span class="n">The</span> <span class="n">following</span> <span class="n">NEW</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">installed</span><span class="p">:</span>
  <span class="n">firefly</span><span class="o">-</span><span class="n">firmware</span>
<span class="mi">0</span> <span class="n">upgraded</span><span class="p">,</span> <span class="mi">1</span> <span class="n">newly</span> <span class="n">installed</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="n">remove</span> <span class="ow">and</span> <span class="mi">3</span> <span class="ow">not</span> <span class="n">upgraded</span><span class="o">.</span>
<span class="n">Need</span> <span class="n">to</span> <span class="n">get</span> <span class="mi">0</span> <span class="n">B</span><span class="o">/</span><span class="mi">6982</span> <span class="n">kB</span> <span class="n">of</span> <span class="n">archives</span><span class="o">.</span>
<span class="n">After</span> <span class="n">this</span> <span class="n">operation</span><span class="p">,</span> <span class="mi">1024</span> <span class="n">B</span> <span class="n">of</span> <span class="n">additional</span> <span class="n">disk</span> <span class="n">space</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span><span class="o">.</span>
<span class="n">Selecting</span> <span class="n">previously</span> <span class="n">unselected</span> <span class="n">package</span> <span class="n">firefly</span><span class="o">-</span><span class="n">firmware</span><span class="o">.</span>
<span class="p">(</span><span class="n">Reading</span> <span class="n">database</span> <span class="o">...</span> <span class="mi">117088</span> <span class="n">files</span> <span class="ow">and</span> <span class="n">directories</span> <span class="n">currently</span> <span class="n">installed</span><span class="o">.</span><span class="p">)</span>
<span class="n">Preparing</span> <span class="n">to</span> <span class="n">unpack</span> <span class="o">.../</span><span class="n">firefly</span><span class="o">-</span><span class="n">firmware_1</span><span class="o">.</span><span class="mi">0</span><span class="n">_arm64</span><span class="o">.</span><span class="n">deb</span> <span class="o">...</span>
<span class="n">Unpacking</span> <span class="n">firefly</span><span class="o">-</span><span class="n">firmware</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">...</span>
<span class="n">Setting</span> <span class="n">up</span> <span class="n">firefly</span><span class="o">-</span><span class="n">firmware</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">...</span>
<span class="o">-----------</span><span class="n">uboot</span> <span class="n">updating</span><span class="o">------------</span>
<span class="mi">8192</span><span class="o">+</span><span class="mi">0</span> <span class="n">records</span> <span class="ow">in</span>
<span class="mi">8192</span><span class="o">+</span><span class="mi">0</span> <span class="n">records</span> <span class="n">out</span>
<span class="mi">4194304</span> <span class="nb">bytes</span> <span class="p">(</span><span class="mf">4.2</span> <span class="n">MB</span><span class="p">,</span> <span class="mf">4.0</span> <span class="n">MiB</span><span class="p">)</span> <span class="n">copied</span><span class="p">,</span> <span class="mf">0.437281</span> <span class="n">s</span><span class="p">,</span> <span class="mf">9.6</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
<span class="o">-----------</span><span class="n">trust</span> <span class="n">updating</span><span class="o">------------</span>
<span class="mi">8192</span><span class="o">+</span><span class="mi">0</span> <span class="n">records</span> <span class="ow">in</span>
<span class="mi">8192</span><span class="o">+</span><span class="mi">0</span> <span class="n">records</span> <span class="n">out</span>
<span class="mi">4194304</span> <span class="nb">bytes</span> <span class="p">(</span><span class="mf">4.2</span> <span class="n">MB</span><span class="p">,</span> <span class="mf">4.0</span> <span class="n">MiB</span><span class="p">)</span> <span class="n">copied</span><span class="p">,</span> <span class="mf">0.565762</span> <span class="n">s</span><span class="p">,</span> <span class="mf">7.4</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
<span class="o">-----------</span><span class="n">kernel</span> <span class="n">updating</span><span class="o">------------</span>
<span class="mi">39752</span><span class="o">+</span><span class="mi">0</span> <span class="n">records</span> <span class="ow">in</span>
<span class="mi">39752</span><span class="o">+</span><span class="mi">0</span> <span class="n">records</span> <span class="n">out</span>
<span class="mi">20353024</span> <span class="nb">bytes</span> <span class="p">(</span><span class="mi">20</span> <span class="n">MB</span><span class="p">,</span> <span class="mi">19</span> <span class="n">MiB</span><span class="p">)</span> <span class="n">copied</span><span class="p">,</span> <span class="mf">0.1702</span> <span class="n">s</span><span class="p">,</span> <span class="mi">120</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
</pre></div>
</div>
<p>You can see that the poinst script in the deb package was executed during the installation process. After the installation is complete, restart the device and the update is complete.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">/usr/share</span></code> directory, you can also see the <code class="docutils literal notranslate"><span class="pre">kernel</span></code> and <code class="docutils literal notranslate"><span class="pre">uboot</span></code> directories, which store <code class="docutils literal notranslate"><span class="pre">boot.img</span></code>, <code class="docutils literal notranslate"><span class="pre">uboot.img</span></code> and <code class="docutils literal notranslate"><span class="pre">trust.img</span></code> respectively.</p>
<p>Precautions</p>
<ul class="simple">
<li><p>In making the deb package, the directory at the same level as <code class="docutils literal notranslate"><span class="pre">DEBIAN</span></code> is regarded as the root directory, that is, the files placed in the same directory as <code class="docutils literal notranslate"><span class="pre">DEBIAN</span></code>, after the deb package is installed on the client, it can be found in the root directory of the client;</p></li>
<li><p>The files and scripts in the deb package should be adjusted according to their actual situation;</p></li>
<li><p>Every time you modify the configuration file in the warehouse, you must re-import the warehouse directory tree;</p></li>
<li><p>In the nginx server configuration, the <code class="docutils literal notranslate"><span class="pre">root</span></code> parameter configures the address of the warehouse, please modify it according to your actual situation;</p></li>
<li><p>When the client adds the new download source file, please check the correct server address, package warehouse code name and component name. Note that the client must connect to the server;</p></li>
<li><p>The client must use the <code class="docutils literal notranslate"><span class="pre">apt-key</span> <span class="pre">add</span></code> command to add the GPG key before it can obtain the local warehouse information.</p></li>
</ul>
</div>
</div>
<div class="section" id="build-a-distributed-compilation-environment-with-docker">
<h2>Build a distributed compilation environment with Docker<a class="headerlink" href="#build-a-distributed-compilation-environment-with-docker" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">distcc</span></code> is a program used for distributed compilation of C, C++, Objective-C or Objective-C++ code through several machines on the network. <code class="docutils literal notranslate"><span class="pre">distcc</span></code> does not require all machines to share the file system, have synchronized clocks, or have the same libraries and header files installed, as long as the server machine has a suitable compilation tool to compile. This example uses Docker technology to deploy the distcc distributed compilation service on two Firefly-RK3399 devices (arm64) and one PC (x86_64), and then realizes the use of distcc’s distributed compilation features on one of the Firefly-RK3399 devices To speed up the kernel compilation process.</p>
<div class="section" id="ready-to-work">
<h3>Ready to work<a class="headerlink" href="#ready-to-work" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Two Firefly-RK3399 devices;</p></li>
<li><p>Router, network cable;</p></li>
<li><p>PC machine.</p></li>
</ul>
<p>Connect the two devices and the PC to the same LAN. The corresponding IP address after connection is:</p>
<ul class="simple">
<li><p>PC: 192.168.1.100</p></li>
<li><p>Device A: 192.168.1.101</p></li>
<li><p>Device B: 192.168.1.102</p></li>
</ul>
</div>
<div class="section" id="pc-deployment-docker">
<h3>PC deployment Docker<a class="headerlink" href="#pc-deployment-docker" title="Permalink to this headline">¶</a></h3>
<p>Install Docker using script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="o">-</span><span class="n">qO</span><span class="o">-</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">get</span><span class="o">.</span><span class="n">docker</span><span class="o">.</span><span class="n">com</span><span class="o">/</span> <span class="o">|</span> <span class="n">sh</span>
</pre></div>
</div>
<p>In order to enable current ordinary users to execute docker related commands, the current user needs to be added to the dokcer user group:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sudo groupadd docker #add docker user group
sudo gpasswd -a $USER docker #Add the current user to the docker user group
newgrp docker #Update docker user group
</pre></div>
</div>
<p>Start the Docker background service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">docker</span> <span class="n">start</span>
</pre></div>
</div>
<p>Create a new <code class="docutils literal notranslate"><span class="pre">Dockerfile_distcc.x86_64</span></code> file. The contents of the file are as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FROM</span> <span class="n">ubuntu</span><span class="p">:</span><span class="n">bionic</span>
<span class="n">MAINTAINER</span> <span class="n">Firefly</span> <span class="o">&lt;</span><span class="n">service</span><span class="nd">@t</span><span class="o">-</span><span class="n">firefly</span><span class="o">.</span><span class="n">com</span><span class="o">&gt;</span>

<span class="n">ARG</span> <span class="n">DEBIAN_FRONTEND</span><span class="o">=</span><span class="n">noninteractive</span>

<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> \
<span class="o">&amp;&amp;</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">install</span><span class="o">-</span><span class="n">recommends</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">install</span><span class="o">-</span><span class="n">suggests</span>\
<span class="n">gcc</span><span class="o">-</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span> <span class="n">distcc</span>\
    <span class="o">&amp;&amp;</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">clean</span> \
    <span class="o">&amp;&amp;</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">lists</span>

<span class="n">RUN</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">-</span><span class="n">gcc</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">gcc</span> <span class="o">&amp;&amp;</span>\
<span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">-</span><span class="n">gcc</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">cc</span>

<span class="n">EXPOSE</span> <span class="mi">3632</span>

<span class="n">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&quot;/usr/bin/distccd&quot;</span><span class="p">]</span>
<span class="n">CMD</span> <span class="p">[</span><span class="s2">&quot;--no-detach&quot;</span><span class="p">,</span> <span class="s2">&quot;--log-stderr&quot;</span><span class="p">,</span> <span class="s2">&quot;--log-level&quot;</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="s2">&quot;--allow&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0.0.0/0&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Generate Docker image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">distcc_server</span><span class="p">:</span><span class="n">x86_64</span> <span class="o">-</span><span class="n">f</span> <span class="n">Dockerfile_distcc</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span>
</pre></div>
</div>
<p>You can use the command <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">images</span></code> to view the generated Docker image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">images</span>
<span class="n">REPOSITORY</span> <span class="n">TAG</span> <span class="n">IMAGE</span> <span class="n">ID</span> <span class="n">CREATED</span> <span class="n">SIZE</span>
<span class="n">distcc_server</span> <span class="n">x86_64</span> <span class="mi">138</span><span class="n">c0b7e3801</span> <span class="mi">9</span> <span class="n">minutes</span> <span class="n">ago</span> <span class="mf">66.1</span><span class="n">MB</span>
</pre></div>
</div>
<p>Start the Docker container with the newly created image, and provide the distcc service on the 3632 TCP port of the host network:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">p</span> <span class="mi">3632</span><span class="p">:</span><span class="mi">3632</span> <span class="n">distcc_server</span><span class="p">:</span><span class="n">x86_64</span>
</pre></div>
</div>
<p>Use the command <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">ps</span></code> to view the running container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">ps</span>
<span class="n">CONTAINER</span> <span class="n">ID</span>    <span class="n">IMAGE</span>                  <span class="n">COMMAND</span>                  <span class="n">CREATED</span>         <span class="n">STATUS</span>          <span class="n">PORTS</span>                    <span class="n">NAMES</span>
<span class="n">fa468d068185</span>    <span class="n">distcc_server</span><span class="p">:</span><span class="n">x86_64</span>   <span class="s2">&quot;/usr/bin/distccd --…&quot;</span>   <span class="mi">9</span> <span class="n">minutes</span> <span class="n">ago</span>   <span class="n">Up</span> <span class="mi">9</span> <span class="n">minutes</span>    <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span><span class="p">:</span><span class="mi">3632</span><span class="o">-&gt;</span><span class="mi">3632</span><span class="o">/</span><span class="n">tcp</span>   <span class="n">epic_chatterjee</span>
</pre></div>
</div>
</div>
<div class="section" id="device-deployment-docker">
<h3>Device deployment Docker<a class="headerlink" href="#device-deployment-docker" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">wget</span> <span class="o">-</span><span class="n">qO</span><span class="o">-</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">get</span><span class="o">.</span><span class="n">docker</span><span class="o">.</span><span class="n">com</span><span class="o">/</span> <span class="o">|</span> <span class="n">sh</span>
</pre></div>
</div>
<p>Add the current user to the dokcer user group:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sudo groupadd docker
sudo gpasswd -a $USER docker
newgrp docker #Update docker
</pre></div>
</div>
<p>Start the Docker background service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">docker</span> <span class="n">start</span>
</pre></div>
</div>
<p>Create a new <code class="docutils literal notranslate"><span class="pre">Dockerfile_distcc.arm64</span></code> file with the following content:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FROM</span> <span class="n">ubuntu</span><span class="p">:</span><span class="n">bionic</span>
<span class="n">MAINTAINER</span> <span class="n">Firefly</span> <span class="o">&lt;</span><span class="n">service</span><span class="nd">@t</span><span class="o">-</span><span class="n">firefly</span><span class="o">.</span><span class="n">com</span><span class="o">&gt;</span>

<span class="n">ARG</span> <span class="n">DEBIAN_FRONTEND</span><span class="o">=</span><span class="n">noninteractive</span>

<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> \
<span class="o">&amp;&amp;</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">install</span><span class="o">-</span><span class="n">recommends</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">install</span><span class="o">-</span><span class="n">suggests</span> \
<span class="n">gcc</span> <span class="n">distcc</span>\
    <span class="o">&amp;&amp;</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">clean</span> \
    <span class="o">&amp;&amp;</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">lists</span>

<span class="n">EXPOSE</span> <span class="mi">3632</span>

<span class="n">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&quot;/usr/bin/distccd&quot;</span><span class="p">]</span>
<span class="n">CMD</span> <span class="p">[</span><span class="s2">&quot;--no-detach&quot;</span><span class="p">,</span> <span class="s2">&quot;--log-stderr&quot;</span><span class="p">,</span> <span class="s2">&quot;--log-level&quot;</span><span class="p">,</span> <span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="s2">&quot;--allow&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0.0.0/0&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Generate Docker image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">distcc_server</span><span class="p">:</span><span class="n">arm64</span> <span class="o">-</span><span class="n">f</span> <span class="n">Dockerfile_distcc</span><span class="o">.</span><span class="n">arm64</span><span class="o">.</span>
</pre></div>
</div>
<p>Start the Docker container with the newly created image, and provide the distcc service on the 3632 TCP port of the host network:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">p</span> <span class="mi">3632</span><span class="p">:</span><span class="mi">3632</span> <span class="n">distcc_server</span><span class="p">:</span><span class="n">arm64</span>
</pre></div>
</div>
<p>Use the <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">save</span></code> command to export the newly created image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">save</span> <span class="o">-</span><span class="n">o</span> <span class="n">distcc_server</span><span class="o">.</span><span class="n">tar</span> <span class="n">distcc_server</span><span class="p">:</span><span class="n">arm64</span>
</pre></div>
</div>
<p>Copy the generated <code class="docutils literal notranslate"><span class="pre">distcc_server.tar</span></code> file to another device, and then import the image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">load</span> <span class="o">-</span><span class="n">i</span> <span class="n">distcc_server</span><span class="o">.</span><span class="n">tar</span>
</pre></div>
</div>
<p>After importing the image, there is also a <code class="docutils literal notranslate"><span class="pre">distcc_server:arm64</span></code> image on this device, and then you can run a container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">p</span> <span class="mi">3632</span><span class="p">:</span><span class="mi">3632</span> <span class="n">distcc_server</span><span class="p">:</span><span class="n">arm64</span>
</pre></div>
</div>
<p><strong>Tip:</strong> If the user has registered a Docker Hub account, he can use <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">push</span></code> to push the image to the remote warehouse, and use <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">pull</span></code> on another device to pull the image of the remote warehouse. Users can understand related operations by themselves.</p>
</div>
<div class="section" id="the-client-compiles-the-kernel-with-distcc">
<h3>The client compiles the kernel with distcc<a class="headerlink" href="#the-client-compiles-the-kernel-with-distcc" title="Permalink to this headline">¶</a></h3>
<p>So far, all three machines have deployed a distributed compilation environment. You can choose any machine as the client, and the remaining two machines as the server. Choose one of the devices as the client.</p>
<p>Create a <code class="docutils literal notranslate"><span class="pre">Dockerfile_compile.arm64</span></code> file in the client to generate a Docker image for compiling the kernel. The content of the file is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FROM</span> <span class="n">ubuntu</span><span class="p">:</span><span class="n">bionic</span>
<span class="n">MAINTAINER</span> <span class="n">Firefly</span> <span class="o">&lt;</span><span class="n">service</span><span class="nd">@t</span><span class="o">-</span><span class="n">firefly</span><span class="o">.</span><span class="n">com</span><span class="o">&gt;</span>

<span class="n">ARG</span> <span class="n">DEBIAN_FRONTEND</span><span class="o">=</span><span class="n">noninteractive</span>

<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> \
    <span class="o">&amp;&amp;</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">install</span><span class="o">-</span><span class="n">recommends</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">install</span><span class="o">-</span><span class="n">suggests</span> \
<span class="n">bc</span> <span class="n">make</span> <span class="n">python</span> <span class="n">sed</span> <span class="n">libssl</span><span class="o">-</span><span class="n">dev</span> <span class="n">binutils</span> <span class="n">build</span><span class="o">-</span><span class="n">essential</span> <span class="n">distcc</span>\
    <span class="n">liblz4</span><span class="o">-</span><span class="n">tool</span> <span class="n">gcc</span> \
    <span class="o">&amp;&amp;</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">clean</span> \
    <span class="o">&amp;&amp;</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">lists</span>
</pre></div>
</div>
<p>Then generate a mirror:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="nb">compile</span><span class="p">:</span><span class="n">arm64</span> <span class="o">-</span><span class="n">f</span> <span class="n">Dockerfile_compile</span><span class="o">.</span><span class="n">arm64</span><span class="o">.</span>
</pre></div>
</div>
<p>Pull the kernel file to the client before starting the container. Then create the <code class="docutils literal notranslate"><span class="pre">/etc/distcc/hosts</span></code> file, its content is to list all the IP addresses of the machines that provide distcc services. The content is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># As described in the distcc manpage, this file can be used for a global</span>
<span class="c1"># list of available distcc hosts.</span>
<span class="c1">#</span>
<span class="c1"># The list from this file will only be used, if neither the</span>
<span class="c1"># environment variable DISTCC_HOSTS, nor the file $HOME/.distcc/hosts</span>
<span class="c1"># contains a valid list of hosts.</span>
<span class="c1">#</span>
<span class="c1"># Add a list of hostnames in one line, seperated by spaces, here.</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">1.100</span>
<span class="mf">192.168</span><span class="o">.</span><span class="mf">1.101</span>
<span class="mf">193.168</span><span class="o">.</span><span class="mf">1.102</span>
</pre></div>
</div>
<p>In order to test the results more accurately, first clear the cache on the client device:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="mi">3</span><span class="o">&gt;</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">vm</span><span class="o">/</span><span class="n">drop_caches</span>
</pre></div>
</div>
<p>Start a Docker container with the <code class="docutils literal notranslate"><span class="pre">compile:arm64</span></code> image, and at the same time mount the host’s current kernel directory to the <code class="docutils literal notranslate"><span class="pre">/mnt</span></code> directory in the container, and mount the host’s <code class="docutils literal notranslate"><span class="pre">/etc/distcc/hosts</span></code> file to the container<code class="docutils literal notranslate"><span class="pre">/etc</span> <span class="pre">/distcc/hosts</span></code> and use the parameter <code class="docutils literal notranslate"><span class="pre">-it</span></code> to start the container in interactive mode:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>docker run -it --rm -v $(pwd):/mnt -v /etc/distcc/hosts:/etc/distcc/hosts compile:arm64 /bin/bash
root@f4415264351b:/# ls
bin boot dev etc home lib media mnt opt ​​proc root run sbin srv sys tmp usr var
root@f4415264351b:/# cd mnt/
</pre></div>
</div>
<p>Enter the <code class="docutils literal notranslate"><span class="pre">/mnt</span></code> directory in the container, and then start to compile the kernel with distcc, add the <code class="docutils literal notranslate"><span class="pre">time</span></code> command to view the execution time of the compilation command, the <code class="docutils literal notranslate"><span class="pre">CC</span></code> parameter indicates to use <code class="docutils literal notranslate"><span class="pre">distcc</span></code> to compile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">time</span> <span class="n">make</span> <span class="n">ARCH</span><span class="o">=</span><span class="n">arm64</span> <span class="n">rk3399</span><span class="o">-</span><span class="n">firefly</span><span class="o">.</span><span class="n">img</span> <span class="o">-</span><span class="n">j32</span> <span class="n">CC</span><span class="o">=</span><span class="s2">&quot;distcc&quot;</span>
</pre></div>
</div>
<p><strong>Note:</strong> If you use a PC as the client, you need to use the following command to compile:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">time</span> <span class="n">make</span> <span class="n">ARCH</span><span class="o">=</span><span class="n">arm64</span> <span class="n">CROSS_COMPILE</span><span class="o">=</span><span class="n">aarch64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">-</span> <span class="n">rk3399</span><span class="o">-</span><span class="n">firefly</span><span class="o">.</span><span class="n">img</span> <span class="o">-</span><span class="n">j32</span> <span class="n">CC</span><span class="o">=</span><span class="s2">&quot;distcc aarch64-linux-gnu-gcc&quot;</span>
</pre></div>
</div>
<p>During the compilation process, you can use the command <code class="docutils literal notranslate"><span class="pre">distccmon-text</span> <span class="pre">1</span></code> to view the compilation status in a new window in the container used for compilation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">distccmon</span><span class="o">-</span><span class="n">text</span> <span class="mi">1</span>
                    <span class="o">...</span>
<span class="mi">15713</span> <span class="n">Compile</span> <span class="n">perf_regs</span><span class="o">.</span><span class="n">c</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.101</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="mi">15327</span> <span class="n">Compile</span> <span class="n">fork</span><span class="o">.</span><span class="n">c</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.101</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="mi">15119</span> <span class="n">Compile</span> <span class="n">dma</span><span class="o">-</span><span class="n">mapping</span><span class="o">.</span><span class="n">c</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.101</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="mi">15552</span> <span class="n">Compile</span> <span class="n">signal32</span><span class="o">.</span><span class="n">c</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.100</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="mi">15644</span> <span class="n">Compile</span> <span class="nb">open</span><span class="o">.</span><span class="n">c</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.100</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="mi">15112</span> <span class="n">Compile</span> <span class="n">traps</span><span class="o">.</span><span class="n">c</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.100</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="mi">15670</span> <span class="n">Compile</span> <span class="n">arm64ksyms</span><span class="o">.</span><span class="n">c</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.102</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="mi">15629</span> <span class="n">Compile</span> <span class="n">mempool</span><span class="o">.</span><span class="n">c</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.102</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="mi">15606</span> <span class="n">Compile</span> <span class="n">filemap</span><span class="o">.</span><span class="n">c</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.102</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="mi">15771</span> <span class="n">Preprocess</span> <span class="n">localhost</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="mi">15573</span> <span class="n">Preprocess</span> <span class="n">localhost</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="mi">15485</span> <span class="n">Preprocess</span> <span class="n">localhost</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="o">...</span>
</pre></div>
</div>
<p>After the final compilation command is completed, you can see the time taken for compilation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">real</span> <span class="mi">15</span><span class="n">m44</span><span class="o">.</span><span class="mi">809</span><span class="n">s</span>
<span class="n">user</span> <span class="mi">16</span><span class="n">m0</span><span class="o">.</span><span class="mi">029</span><span class="n">s</span>
<span class="n">sys</span> <span class="mi">6</span><span class="n">m22</span><span class="o">.</span><span class="mi">317</span><span class="n">s</span>
</pre></div>
</div>
<p>The following is the time it takes to compile the kernel with a single device:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">real</span> <span class="mi">23</span><span class="n">m33</span><span class="o">.</span><span class="mi">002</span><span class="n">s</span>
<span class="n">user</span> <span class="mi">113</span><span class="n">m2</span><span class="o">.</span><span class="mi">615</span><span class="n">s</span>
<span class="n">sys</span> <span class="mi">9</span><span class="n">m29</span><span class="o">.</span><span class="mi">348</span><span class="n">s</span>
</pre></div>
</div>
<p>By comparison, it can be seen that the distributed compilation implemented by distcc can effectively improve the compilation speed.</p>
<p><strong>note:</strong></p>
<ul class="simple">
<li><p>Different platforms require different compilers. For example, on the x86_64 platform, you need to install the corresponding cross-compilation tool <code class="docutils literal notranslate"><span class="pre">gcc-aarch64-linux-gnu</span></code>. On the arm64 platform, you only need to install the <code class="docutils literal notranslate"><span class="pre">gcc</span></code> compilation tool. Users need to specify and install the correct tool in the corresponding <code class="docutils literal notranslate"><span class="pre">Dockerfile</span></code> file according to the actual situation.</p></li>
<li><p>If you use a PC as a client, you must use the parameter <code class="docutils literal notranslate"><span class="pre">CC=&quot;distcc</span> <span class="pre">aarch64-linux-gnu-gcc&quot;</span></code> to specify the use of <code class="docutils literal notranslate"><span class="pre">aarch64-linux-gnu-gcc</span></code> when compiling the kernel in the container used for compilation Compile with cross-compiler tools.</p></li>
</ul>
</div>
</div>
<div class="section" id="android-7-1-upgrade-to-ubuntu">
<h2>Android 7.1 upgrade to Ubuntu<a class="headerlink" href="#android-7-1-upgrade-to-ubuntu" title="Permalink to this headline">¶</a></h2>
<p><strong>This upgrade method is only applicable to RK3399, and the firmware currently running on the board is Android 7.1</strong></p>
<p>If the factory firmware of RK3399 board is Android 7.1, when using TF card to upgrade to Ubuntu, because the eMMC boot priority in Maskrom is higher than TF card, so the miniloader in eMMC will be started first, then miniloader will start U in TF card. -Boot. But the miniloader of Android 7.1 is not compatible with the U-Boot of Ubuntu, which will cause errors. The solution is: use Android 7.1 Bootloader, user Ubuntu firmware kernel and customized recovery memory disk to make Ubuntu upgrade card, successfully realize the boot chain “MaskRom -&gt; eMMC Android miniloader -&gt; TF Android U-Boot -&gt; TF Ubuntu Kernel -&gt; TF recovery system” works normally.</p>
<div class="section" id="material-preparation">
<h3>Material preparation<a class="headerlink" href="#material-preparation" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>A TF card.</p></li>
<li><p>The equipment to be upgraded.</p></li>
<li><p>The Ubuntu firmware corresponding to the board type.</p></li>
<li><p>Download related files and scripts required for operation: <a class="reference external" href="https://download.t-firefly.com/product/RK3399/Tools/ubuntu_sd_update/ubuntu_sd_update.zip">ubuntu_sd_update.zip</a>.</p></li>
</ol>
</div>
<div class="section" id="upgrade-card-production-process">
<h3>Upgrade card production process<a class="headerlink" href="#upgrade-card-production-process" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Unzip <code class="docutils literal notranslate"><span class="pre">ubuntu_sd_update.zip</span></code> and enter the <code class="docutils literal notranslate"><span class="pre">ubuntu_sd_update</span></code> directory;</p></li>
<li><p>Copy the Ubuntu firmware corresponding to the board type to this directory and rename it to <code class="docutils literal notranslate"><span class="pre">update.img</span></code> (or <code class="docutils literal notranslate"><span class="pre">ln</span> <span class="pre">-sf</span> <span class="pre">xxx</span> <span class="pre">update.img</span></code>);</p></li>
<li><p>Execute <code class="docutils literal notranslate"><span class="pre">./unpack.sh</span></code> to unpack the Ubuntu firmware;</p></li>
<li><p>Then execute <code class="docutils literal notranslate"><span class="pre">./mkSDCreate.sh</span></code> to generate <code class="docutils literal notranslate"><span class="pre">sdCreate.img</span></code>;</p></li>
<li><p>Use the <a class="reference external" href="https://www.t-firefly.com/doc/download/145.html#other_401">SD_Firmware_Tool</a> tool and select <code class="docutils literal notranslate"><span class="pre">sdCreate.img</span></code> to complete the creation of the upgrade card;</p></li>
<li><p>Copy the Ubuntu firmware to the TF card and rename it to <code class="docutils literal notranslate"><span class="pre">sdupdate.img</span></code>.</p></li>
</ol>
</div>
<div class="section" id="equipment-upgrade-process">
<h3>Equipment upgrade process<a class="headerlink" href="#equipment-upgrade-process" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Power off the device.</p></li>
<li><p>Insert the TF card, power on, and the device will automatically enter the upgrade operation, during which one of the machine’s LED lights will continue to flash, depending on the size of the firmware, the upgrade time will be longer.</p></li>
<li><p>The upgrade is complete and the LED light stops flashing.</p></li>
<li><p>Pull out the TF card, and power on the facing board again.</p></li>
</ol>
</div>
<div class="section" id="special-cases">
<h3>Special cases<a class="headerlink" href="#special-cases" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>In practical applications, some users’ upgrade firmware size exceeds 4G. After <a class="reference external" href="https://www.t-firefly.com/doc/download/145.html#other_401">SD_Firmware_Tool</a> has finished making the upgrade card, the TF card is formatted with FAT32, which results in the user’s firmware cannot be placed in the TF card. At this point, after making the upgrade card, first back up the two files <code class="docutils literal notranslate"><span class="pre">rksdfw.tag</span></code> and <code class="docutils literal notranslate"><span class="pre">sd_boot_config.config</span></code> in the TF card, and then reformat the FAT32 partition of the TF card to NTFS or exFAT on Windows, and then Then copy the backed up files and user firmware to the TF card.</p></li>
<li><p>If the device enters recovery mode after the card is turned on, but the upgrade operation is not performed automatically, please re-plug the TF card in recovery mode, and the upgrade operation can continue normally.</p></li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Firefly Team.
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "../../../hm.baidu.com/hmfe8c.js?a59c4f3b4ec58882544d7cc51d1d78e1";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
      </script>
      
    </p>
    
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org/">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.0.0',
            LANGUAGE:'en',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script>

  <style>
    /* 触发弹窗图片的样式 */
    /* #myImg {
      border-radius: 5px;
      cursor: pointer;
      transition: 0.3s;
    }

    #myImg:hover {
      opacity: 0.7;
    } */

    /* 弹窗背景 */
    .modal-img {
      display: none;
      /* Hidden by default */
      position: fixed;
      /* 设置显示的优先层级级别 */
      z-index: 1234;
      /* Sit on top */
      /* padding-top: 100px; */
      /* Location of the box */
      left: 0;
      top: 0;
      width: 100%;
      /* Full width */
      height: 100%;
      /* Full height */
      overflow: auto;
      /* Enable scroll if needed */
      background-color: rgb(0, 0, 0);
      /* Fallback color */
      background-color: rgba(0, 0, 0, 0.9);
      /* Black w/ opacity */
    }

    .modal-img-flex{
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
    }

    /* 设置弹出图片的样式 */
    .modal-content {
      margin: auto;
      display: block;
      max-height: 100%;
      /* width: 40%; */
      /* max-width: 430px; */
    }

    /* 设置文本内容的样式 */
    /* #caption {
      margin: auto;
      display: block;
      width: 80%;
      max-width: 700px;
      text-align: center;
      color: #ccc;
      padding: 10px 0;
      height: 150px;
    } */

    /* 设置弹出图片的动画，添加动画 */
    /* .modal-content{
      -webkit-animation-name: zoom;
      -webkit-animation-duration: 0.6s;
      animation-name: zoom;
      animation-duration: 0.6s;
    } */

    @-webkit-keyframes zoom {
      from {
        -webkit-transform: scale(0)
      }

      to {
        -webkit-transform: scale(1)
      }
    }

    @keyframes zoom {
      from {
        transform: scale(0)
      }

      to {
        transform: scale(1)
      }
    }

    /* 设置span标签的关闭按钮样式 */
    .close {
      position: absolute;
      top: 100px;
      right: 400px;
      color: #f1f1f1;
      font-size: 40px;
      font-weight: bold;
      transition: 0.3s;
    }

    .close:hover,
    .close:focus {
      color: #bbb;
      text-decoration: none;
      cursor: pointer;
    }

    /* 小屏幕中图片宽度为 100% */
    @media only screen and (max-width: 700px) {
      .modal-content {
        width: 100%;
      }
    }
  </style>
  
<div class="modal-img">
    
    <img src="#" alt="" data-large="" class="modal-content">
    <span class="close">&times;</span>

</div>

<script type="text/javascript" src="_static/js/zoomsl.min.js"></script>

<script type="text/javascript">
    jQuery(function () {
        jQuery('.document a').click(function(){
          console.log(this.href)

          var fileExt=(/[.]/.exec(this.href)) ? /[^.]+$/.exec(this.href.toLowerCase()) : '';

          if(fileExt[0] === 'jpg' || fileExt[0] === 'png' || fileExt[0] === 'jpeg'){
            jQuery('.modal-img').addClass('modal-img-flex');
            jQuery('.modal-content').attr('src', this.href);
            jQuery('.modal-content').data('large', this.href);

            // jQuery('.modal-content').imagezoomsl({
            //   magnifiereffectanimate: "fadeIn"
            // });
            return false
          }
          
        })

        jQuery('.modal-img').click(function(){
            // jQuery('.modal-img').hide()
            jQuery('.modal-img').removeClass('modal-img-flex');
            jQuery('.modal-content').attr('src', '');
        })
    });
</script> 

</body>

<!-- Mirrored from wiki.t-firefly.com/en/ROC-RK3399-PC-Pro/ubuntu_manual.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 29 Sep 2022 08:28:43 GMT -->
</html>